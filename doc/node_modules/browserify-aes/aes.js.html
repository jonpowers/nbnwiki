<!DOCTYPE html>
<html>
<head>
  <title>aes.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/browserify-aes/aes.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>aes.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>based on the aes implimentation in triple sec
https://github.com/keybase/triplesec</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>which is in turn based on the one from crypto-js
https://code.google.com/p/crypto-js/</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> uint_max = <span class="hljs-built_in">Math</span>.pow(<span class="hljs-number">2</span>, <span class="hljs-number">32</span>)
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">fixup_uint32</span> (<span class="hljs-params">x</span>) </span>{
  <span class="hljs-keyword">var</span> ret, x_pos
  ret = x &gt; uint_max || x &lt; <span class="hljs-number">0</span> ? (x_pos = <span class="hljs-built_in">Math</span>.abs(x) % uint_max, x &lt; <span class="hljs-number">0</span> ? uint_max - x_pos : x_pos) : x
  <span class="hljs-keyword">return</span> ret
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">scrub_vec</span> (<span class="hljs-params">v</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; v.length; v++) {
    v[i] = <span class="hljs-number">0</span>
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">Global</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">this</span>.SBOX = []
  <span class="hljs-keyword">this</span>.INV_SBOX = []
  <span class="hljs-keyword">this</span>.SUB_MIX = [[], [], [], []]
  <span class="hljs-keyword">this</span>.INV_SUB_MIX = [[], [], [], []]
  <span class="hljs-keyword">this</span>.init()
  <span class="hljs-keyword">this</span>.RCON = [<span class="hljs-number">0x00</span>, <span class="hljs-number">0x01</span>, <span class="hljs-number">0x02</span>, <span class="hljs-number">0x04</span>, <span class="hljs-number">0x08</span>, <span class="hljs-number">0x10</span>, <span class="hljs-number">0x20</span>, <span class="hljs-number">0x40</span>, <span class="hljs-number">0x80</span>, <span class="hljs-number">0x1b</span>, <span class="hljs-number">0x36</span>]
}

Global.prototype.init = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> d, i, sx, t, x, x2, x4, x8, xi, _i
  d = (<span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">var</span> _i, _results
    _results = []
    <span class="hljs-keyword">for</span> (i = _i = <span class="hljs-number">0</span>; _i &lt; <span class="hljs-number">256</span>; i = ++_i) {
      <span class="hljs-keyword">if</span> (i &lt; <span class="hljs-number">128</span>) {
        _results.push(i &lt;&lt; <span class="hljs-number">1</span>)
      } <span class="hljs-keyword">else</span> {
        _results.push((i &lt;&lt; <span class="hljs-number">1</span>) ^ <span class="hljs-number">0x11b</span>)
      }
    }
    <span class="hljs-keyword">return</span> _results
  })()
  x = <span class="hljs-number">0</span>
  xi = <span class="hljs-number">0</span>
  <span class="hljs-keyword">for</span> (i = _i = <span class="hljs-number">0</span>; _i &lt; <span class="hljs-number">256</span>; i = ++_i) {
    sx = xi ^ (xi &lt;&lt; <span class="hljs-number">1</span>) ^ (xi &lt;&lt; <span class="hljs-number">2</span>) ^ (xi &lt;&lt; <span class="hljs-number">3</span>) ^ (xi &lt;&lt; <span class="hljs-number">4</span>)
    sx = (sx &gt;&gt;&gt; <span class="hljs-number">8</span>) ^ (sx &amp; <span class="hljs-number">0xff</span>) ^ <span class="hljs-number">0x63</span>
    <span class="hljs-keyword">this</span>.SBOX[x] = sx
    <span class="hljs-keyword">this</span>.INV_SBOX[sx] = x
    x2 = d[x]
    x4 = d[x2]
    x8 = d[x4]
    t = (d[sx] * <span class="hljs-number">0x101</span>) ^ (sx * <span class="hljs-number">0x1010100</span>)
    <span class="hljs-keyword">this</span>.SUB_MIX[<span class="hljs-number">0</span>][x] = (t &lt;&lt; <span class="hljs-number">24</span>) | (t &gt;&gt;&gt; <span class="hljs-number">8</span>)
    <span class="hljs-keyword">this</span>.SUB_MIX[<span class="hljs-number">1</span>][x] = (t &lt;&lt; <span class="hljs-number">16</span>) | (t &gt;&gt;&gt; <span class="hljs-number">16</span>)
    <span class="hljs-keyword">this</span>.SUB_MIX[<span class="hljs-number">2</span>][x] = (t &lt;&lt; <span class="hljs-number">8</span>) | (t &gt;&gt;&gt; <span class="hljs-number">24</span>)
    <span class="hljs-keyword">this</span>.SUB_MIX[<span class="hljs-number">3</span>][x] = t
    t = (x8 * <span class="hljs-number">0x1010101</span>) ^ (x4 * <span class="hljs-number">0x10001</span>) ^ (x2 * <span class="hljs-number">0x101</span>) ^ (x * <span class="hljs-number">0x1010100</span>)
    <span class="hljs-keyword">this</span>.INV_SUB_MIX[<span class="hljs-number">0</span>][sx] = (t &lt;&lt; <span class="hljs-number">24</span>) | (t &gt;&gt;&gt; <span class="hljs-number">8</span>)
    <span class="hljs-keyword">this</span>.INV_SUB_MIX[<span class="hljs-number">1</span>][sx] = (t &lt;&lt; <span class="hljs-number">16</span>) | (t &gt;&gt;&gt; <span class="hljs-number">16</span>)
    <span class="hljs-keyword">this</span>.INV_SUB_MIX[<span class="hljs-number">2</span>][sx] = (t &lt;&lt; <span class="hljs-number">8</span>) | (t &gt;&gt;&gt; <span class="hljs-number">24</span>)
    <span class="hljs-keyword">this</span>.INV_SUB_MIX[<span class="hljs-number">3</span>][sx] = t
    <span class="hljs-keyword">if</span> (x === <span class="hljs-number">0</span>) {
      x = xi = <span class="hljs-number">1</span>
    } <span class="hljs-keyword">else</span> {
      x = x2 ^ d[d[d[x8 ^ x2]]]
      xi ^= d[d[xi]]
    }
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

<span class="hljs-keyword">var</span> G = <span class="hljs-keyword">new</span> Global()

AES.blockSize = <span class="hljs-number">4</span> * <span class="hljs-number">4</span>

AES.prototype.blockSize = AES.blockSize

AES.keySize = <span class="hljs-number">256</span> / <span class="hljs-number">8</span>

AES.prototype.keySize = AES.keySize

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bufferToArray</span> (<span class="hljs-params">buf</span>) </span>{
  <span class="hljs-keyword">var</span> len = buf.length / <span class="hljs-number">4</span>
  <span class="hljs-keyword">var</span> out = <span class="hljs-keyword">new</span> <span class="hljs-built_in">Array</span>(len)
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">-1</span>
  <span class="hljs-keyword">while</span> (++i &lt; len) {
    out[i] = buf.readUInt32BE(i * <span class="hljs-number">4</span>)
  }
  <span class="hljs-keyword">return</span> out
}
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">AES</span> (<span class="hljs-params">key</span>) </span>{
  <span class="hljs-keyword">this</span>._key = bufferToArray(key)
  <span class="hljs-keyword">this</span>._doReset()
}

AES.prototype._doReset = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">var</span> invKsRow, keySize, keyWords, ksRow, ksRows, t
  keyWords = <span class="hljs-keyword">this</span>._key
  keySize = keyWords.length
  <span class="hljs-keyword">this</span>._nRounds = keySize + <span class="hljs-number">6</span>
  ksRows = (<span class="hljs-keyword">this</span>._nRounds + <span class="hljs-number">1</span>) * <span class="hljs-number">4</span>
  <span class="hljs-keyword">this</span>._keySchedule = []
  <span class="hljs-keyword">for</span> (ksRow = <span class="hljs-number">0</span>; ksRow &lt; ksRows; ksRow++) {
    <span class="hljs-keyword">this</span>._keySchedule[ksRow] = ksRow &lt; keySize ? keyWords[ksRow] : (t = <span class="hljs-keyword">this</span>._keySchedule[ksRow - <span class="hljs-number">1</span>], (ksRow % keySize) === <span class="hljs-number">0</span> ? (t = (t &lt;&lt; <span class="hljs-number">8</span>) | (t &gt;&gt;&gt; <span class="hljs-number">24</span>), t = (G.SBOX[t &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | G.SBOX[t &amp; <span class="hljs-number">0xff</span>], t ^= G.RCON[(ksRow / keySize) | <span class="hljs-number">0</span>] &lt;&lt; <span class="hljs-number">24</span>) : keySize &gt; <span class="hljs-number">6</span> &amp;&amp; ksRow % keySize === <span class="hljs-number">4</span> ? t = (G.SBOX[t &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | G.SBOX[t &amp; <span class="hljs-number">0xff</span>] : <span class="hljs-keyword">void</span> <span class="hljs-number">0</span>, <span class="hljs-keyword">this</span>._keySchedule[ksRow - keySize] ^ t)
  }
  <span class="hljs-keyword">this</span>._invKeySchedule = []
  <span class="hljs-keyword">for</span> (invKsRow = <span class="hljs-number">0</span>; invKsRow &lt; ksRows; invKsRow++) {
    ksRow = ksRows - invKsRow
    t = <span class="hljs-keyword">this</span>._keySchedule[ksRow - (invKsRow % <span class="hljs-number">4</span> ? <span class="hljs-number">0</span> : <span class="hljs-number">4</span>)]
    <span class="hljs-keyword">this</span>._invKeySchedule[invKsRow] = invKsRow &lt; <span class="hljs-number">4</span> || ksRow &lt;= <span class="hljs-number">4</span> ? t : G.INV_SUB_MIX[<span class="hljs-number">0</span>][G.SBOX[t &gt;&gt;&gt; <span class="hljs-number">24</span>]] ^ G.INV_SUB_MIX[<span class="hljs-number">1</span>][G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>]] ^ G.INV_SUB_MIX[<span class="hljs-number">2</span>][G.SBOX[(t &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>]] ^ G.INV_SUB_MIX[<span class="hljs-number">3</span>][G.SBOX[t &amp; <span class="hljs-number">0xff</span>]]
  }
  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

AES.prototype.encryptBlock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">M</span>) </span>{
  M = bufferToArray(<span class="hljs-keyword">new</span> Buffer(M))
  <span class="hljs-keyword">var</span> out = <span class="hljs-keyword">this</span>._doCryptBlock(M, <span class="hljs-keyword">this</span>._keySchedule, G.SUB_MIX, G.SBOX)
  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">16</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">1</span>], <span class="hljs-number">4</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">2</span>], <span class="hljs-number">8</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">3</span>], <span class="hljs-number">12</span>)
  <span class="hljs-keyword">return</span> buf
}

AES.prototype.decryptBlock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">M</span>) </span>{
  M = bufferToArray(<span class="hljs-keyword">new</span> Buffer(M))
  <span class="hljs-keyword">var</span> temp = [M[<span class="hljs-number">3</span>], M[<span class="hljs-number">1</span>]]
  M[<span class="hljs-number">1</span>] = temp[<span class="hljs-number">0</span>]
  M[<span class="hljs-number">3</span>] = temp[<span class="hljs-number">1</span>]
  <span class="hljs-keyword">var</span> out = <span class="hljs-keyword">this</span>._doCryptBlock(M, <span class="hljs-keyword">this</span>._invKeySchedule, G.INV_SUB_MIX, G.INV_SBOX)
  <span class="hljs-keyword">var</span> buf = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-number">16</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">0</span>], <span class="hljs-number">0</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">3</span>], <span class="hljs-number">4</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">2</span>], <span class="hljs-number">8</span>)
  buf.writeUInt32BE(out[<span class="hljs-number">1</span>], <span class="hljs-number">12</span>)
  <span class="hljs-keyword">return</span> buf
}

AES.prototype.scrub = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
  scrub_vec(<span class="hljs-keyword">this</span>._keySchedule)
  scrub_vec(<span class="hljs-keyword">this</span>._invKeySchedule)
  scrub_vec(<span class="hljs-keyword">this</span>._key)
}

AES.prototype._doCryptBlock = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params">M, keySchedule, SUB_MIX, SBOX</span>) </span>{
  <span class="hljs-keyword">var</span> ksRow, s0, s1, s2, s3, t0, t1, t2, t3

  s0 = M[<span class="hljs-number">0</span>] ^ keySchedule[<span class="hljs-number">0</span>]
  s1 = M[<span class="hljs-number">1</span>] ^ keySchedule[<span class="hljs-number">1</span>]
  s2 = M[<span class="hljs-number">2</span>] ^ keySchedule[<span class="hljs-number">2</span>]
  s3 = M[<span class="hljs-number">3</span>] ^ keySchedule[<span class="hljs-number">3</span>]
  ksRow = <span class="hljs-number">4</span>
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> round = <span class="hljs-number">1</span>; round &lt; <span class="hljs-keyword">this</span>._nRounds; round++) {
    t0 = SUB_MIX[<span class="hljs-number">0</span>][s0 &gt;&gt;&gt; <span class="hljs-number">24</span>] ^ SUB_MIX[<span class="hljs-number">1</span>][(s1 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">2</span>][(s2 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">3</span>][s3 &amp; <span class="hljs-number">0xff</span>] ^ keySchedule[ksRow++]
    t1 = SUB_MIX[<span class="hljs-number">0</span>][s1 &gt;&gt;&gt; <span class="hljs-number">24</span>] ^ SUB_MIX[<span class="hljs-number">1</span>][(s2 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">2</span>][(s3 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">3</span>][s0 &amp; <span class="hljs-number">0xff</span>] ^ keySchedule[ksRow++]
    t2 = SUB_MIX[<span class="hljs-number">0</span>][s2 &gt;&gt;&gt; <span class="hljs-number">24</span>] ^ SUB_MIX[<span class="hljs-number">1</span>][(s3 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">2</span>][(s0 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">3</span>][s1 &amp; <span class="hljs-number">0xff</span>] ^ keySchedule[ksRow++]
    t3 = SUB_MIX[<span class="hljs-number">0</span>][s3 &gt;&gt;&gt; <span class="hljs-number">24</span>] ^ SUB_MIX[<span class="hljs-number">1</span>][(s0 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">2</span>][(s1 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] ^ SUB_MIX[<span class="hljs-number">3</span>][s2 &amp; <span class="hljs-number">0xff</span>] ^ keySchedule[ksRow++]
    s0 = t0
    s1 = t1
    s2 = t2
    s3 = t3
  }
  t0 = ((SBOX[s0 &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (SBOX[(s1 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (SBOX[(s2 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | SBOX[s3 &amp; <span class="hljs-number">0xff</span>]) ^ keySchedule[ksRow++]
  t1 = ((SBOX[s1 &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (SBOX[(s2 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (SBOX[(s3 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | SBOX[s0 &amp; <span class="hljs-number">0xff</span>]) ^ keySchedule[ksRow++]
  t2 = ((SBOX[s2 &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (SBOX[(s3 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (SBOX[(s0 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | SBOX[s1 &amp; <span class="hljs-number">0xff</span>]) ^ keySchedule[ksRow++]
  t3 = ((SBOX[s3 &gt;&gt;&gt; <span class="hljs-number">24</span>] &lt;&lt; <span class="hljs-number">24</span>) | (SBOX[(s0 &gt;&gt;&gt; <span class="hljs-number">16</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">16</span>) | (SBOX[(s1 &gt;&gt;&gt; <span class="hljs-number">8</span>) &amp; <span class="hljs-number">0xff</span>] &lt;&lt; <span class="hljs-number">8</span>) | SBOX[s2 &amp; <span class="hljs-number">0xff</span>]) ^ keySchedule[ksRow++]
  <span class="hljs-keyword">return</span> [
    fixup_uint32(t0),
    fixup_uint32(t1),
    fixup_uint32(t2),
    fixup_uint32(t3)
  ]
}

exports.AES = AES

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
