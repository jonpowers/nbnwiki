<!DOCTYPE html>
<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/compression/index.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>index.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<p>!
compression
Copyright(c) 2010 Sencha Inc.
Copyright(c) 2011 TJ Holowaychuk
Copyright(c) 2014 Jonathan Ong
Copyright(c) 2014-2015 Douglas Christopher Wilson
MIT Licensed</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">
'use strict'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module dependencies.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> accepts = <span class="hljs-built_in">require</span>(<span class="hljs-string">'accepts'</span>)
<span class="hljs-keyword">var</span> bytes = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bytes'</span>)
<span class="hljs-keyword">var</span> compressible = <span class="hljs-built_in">require</span>(<span class="hljs-string">'compressible'</span>)
<span class="hljs-keyword">var</span> debug = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'compression'</span>)
<span class="hljs-keyword">var</span> onHeaders = <span class="hljs-built_in">require</span>(<span class="hljs-string">'on-headers'</span>)
<span class="hljs-keyword">var</span> vary = <span class="hljs-built_in">require</span>(<span class="hljs-string">'vary'</span>)
<span class="hljs-keyword">var</span> zlib = <span class="hljs-built_in">require</span>(<span class="hljs-string">'zlib'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module exports.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-built_in">module</span>.exports = compression
<span class="hljs-built_in">module</span>.exports.filter = shouldCompress

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Module variables.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-keyword">var</span> cacheControlNoTransformRegExp = <span class="hljs-regexp">/(?:^|,)\s*?no-transform\s*?(?:,|$)/</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<div class="dox">
<div class="summary">
<p>Compress response data with gzip / deflate.</p>
</div>
<div class="body">
</div>
<div class="details">
<div class="dox_tag_title">Params</div>
<div class="dox_tag_detail">
<span class="dox_tag_name">[options]</span>
<span class="dox_type">Object</span>
</div>
<div class="dox_tag_title">Returns</div>
<div class="dox_tag_detail">
<span class="dox_tag_name"></span>
<span class="dox_type">Function</span>
<span>middleware
</span>
</div>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compression</span> (<span class="hljs-params">options</span>) </span>{
  <span class="hljs-keyword">var</span> opts = options || {}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>options</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">var</span> filter = opts.filter || shouldCompress
  <span class="hljs-keyword">var</span> threshold = bytes.parse(opts.threshold)

  <span class="hljs-keyword">if</span> (threshold == <span class="hljs-literal">null</span>) {
    threshold = <span class="hljs-number">1024</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">compression</span> (<span class="hljs-params">req, res, next</span>) </span>{
    <span class="hljs-keyword">var</span> ended = <span class="hljs-literal">false</span>
    <span class="hljs-keyword">var</span> length
    <span class="hljs-keyword">var</span> listeners = []
    <span class="hljs-keyword">var</span> stream

    <span class="hljs-keyword">var</span> _end = res.end
    <span class="hljs-keyword">var</span> _on = res.on
    <span class="hljs-keyword">var</span> _write = res.write

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>flush</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    res.flush = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">flush</span> (<span class="hljs-params"></span>) </span>{
      <span class="hljs-keyword">if</span> (stream) {
        stream.flush()
      }
    }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>proxy</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
    res.write = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">write</span> (<span class="hljs-params">chunk, encoding</span>) </span>{
      <span class="hljs-keyword">if</span> (ended) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._header) {
        <span class="hljs-keyword">this</span>._implicitHeader()
      }

      <span class="hljs-keyword">return</span> stream
        ? stream.write(<span class="hljs-keyword">new</span> Buffer(chunk, encoding))
        : _write.call(<span class="hljs-keyword">this</span>, chunk, encoding)
    }

    res.end = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">end</span> (<span class="hljs-params">chunk, encoding</span>) </span>{
      <span class="hljs-keyword">if</span> (ended) {
        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
      }

      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._header) {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>estimate the length</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.getHeader(<span class="hljs-string">'Content-Length'</span>)) {
          length = chunkLength(chunk, encoding)
        }

        <span class="hljs-keyword">this</span>._implicitHeader()
      }

      <span class="hljs-keyword">if</span> (!stream) {
        <span class="hljs-keyword">return</span> _end.call(<span class="hljs-keyword">this</span>, chunk, encoding)
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>mark ended</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      ended = <span class="hljs-literal">true</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>write Buffer for Node.js 0.8</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">return</span> chunk
        ? stream.end(<span class="hljs-keyword">new</span> Buffer(chunk, encoding))
        : stream.end()
    }

    res.on = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">on</span> (<span class="hljs-params">type, listener</span>) </span>{
      <span class="hljs-keyword">if</span> (!listeners || type !== <span class="hljs-string">'drain'</span>) {
        <span class="hljs-keyword">return</span> _on.call(<span class="hljs-keyword">this</span>, type, listener)
      }

      <span class="hljs-keyword">if</span> (stream) {
        <span class="hljs-keyword">return</span> stream.on(type, listener)
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>buffer listeners for future stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      listeners.push([type, listener])

      <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>
    }

    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">nocompress</span> (<span class="hljs-params">msg</span>) </span>{
      debug(<span class="hljs-string">'no compression: %s'</span>, msg)
      addListeners(res, _on, listeners)
      listeners = <span class="hljs-literal">null</span>
    }

    onHeaders(res, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponseHeaders</span> (<span class="hljs-params"></span>) </span>{
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>determine if request is filtered</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (!filter(req, res)) {
        nocompress(<span class="hljs-string">'filtered'</span>)
        <span class="hljs-keyword">return</span>
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>determine if the entity should be transformed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (!shouldTransform(req, res)) {
        nocompress(<span class="hljs-string">'no transform'</span>)
        <span class="hljs-keyword">return</span>
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>vary</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      vary(res, <span class="hljs-string">'Accept-Encoding'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>content-length below threshold</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Number</span>(res.getHeader(<span class="hljs-string">'Content-Length'</span>)) &lt; threshold || length &lt; threshold) {
        nocompress(<span class="hljs-string">'size below threshold'</span>)
        <span class="hljs-keyword">return</span>
      }

      <span class="hljs-keyword">var</span> encoding = res.getHeader(<span class="hljs-string">'Content-Encoding'</span>) || <span class="hljs-string">'identity'</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>already encoded</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (encoding !== <span class="hljs-string">'identity'</span>) {
        nocompress(<span class="hljs-string">'already encoded'</span>)
        <span class="hljs-keyword">return</span>
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>head</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (req.method === <span class="hljs-string">'HEAD'</span>) {
        nocompress(<span class="hljs-string">'HEAD request'</span>)
        <span class="hljs-keyword">return</span>
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>compression method</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">var</span> accept = accepts(req)
      <span class="hljs-keyword">var</span> method = accept.encoding([<span class="hljs-string">'gzip'</span>, <span class="hljs-string">'deflate'</span>, <span class="hljs-string">'identity'</span>])

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>we really don't prefer deflate</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (method === <span class="hljs-string">'deflate'</span> &amp;&amp; accept.encoding([<span class="hljs-string">'gzip'</span>])) {
        method = accept.encoding([<span class="hljs-string">'gzip'</span>, <span class="hljs-string">'identity'</span>])
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>negotiation failed</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-keyword">if</span> (!method || method === <span class="hljs-string">'identity'</span>) {
        nocompress(<span class="hljs-string">'not acceptable'</span>)
        <span class="hljs-keyword">return</span>
      }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>compression stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      debug(<span class="hljs-string">'%s compression'</span>, method)
      stream = method === <span class="hljs-string">'gzip'</span>
        ? zlib.createGzip(opts)
        : zlib.createDeflate(opts)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>add buffered listeners to stream</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      addListeners(stream, stream.on, listeners)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>header fields</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      res.setHeader(<span class="hljs-string">'Content-Encoding'</span>, method)
      res.removeHeader(<span class="hljs-string">'Content-Length'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>compression</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">      stream.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onStreamData</span> (<span class="hljs-params">chunk</span>) </span>{
        <span class="hljs-keyword">if</span> (_write.call(res, chunk) === <span class="hljs-literal">false</span>) {
          stream.pause()
        }
      })

      stream.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onStreamEnd</span> (<span class="hljs-params"></span>) </span>{
        _end.call(res)
      })

      _on.call(res, <span class="hljs-string">'drain'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onResponseDrain</span> (<span class="hljs-params"></span>) </span>{
        stream.resume()
      })
    })

    next()
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<div class="dox">
<div class="summary">
<p>Add bufferred listeners to stream</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">addListeners</span> (<span class="hljs-params">stream, on, listeners</span>) </span>{
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; listeners.length; i++) {
    on.apply(stream, listeners[i])
  }
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<div class="dox">
<div class="summary">
<p>Get the length of a given chunk</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">chunkLength</span> (<span class="hljs-params">chunk, encoding</span>) </span>{
  <span class="hljs-keyword">if</span> (!chunk) {
    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>
  }

  <span class="hljs-keyword">return</span> !Buffer.isBuffer(chunk)
    ? Buffer.byteLength(chunk, encoding)
    : chunk.length
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<div class="dox">
<div class="summary">
<p>Default filter function.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldCompress</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">var</span> type = res.getHeader(<span class="hljs-string">'Content-Type'</span>)

  <span class="hljs-keyword">if</span> (type === <span class="hljs-literal">undefined</span> || !compressible(type)) {
    debug(<span class="hljs-string">'%s not compressible'</span>, type)
    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>
  }

  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<div class="dox">
<div class="summary">
<p>Determine if the entity should be transformed.</p>
</div>
<div class="body">
</div>
<div class="details">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">
<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">shouldTransform</span> (<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-keyword">var</span> cacheControl = res.getHeader(<span class="hljs-string">'Cache-Control'</span>)

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Don't compress for Cache-Control: no-transform
https://tools.ietf.org/html/rfc7234#section-5.2.2.4</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">return</span> !cacheControl ||
    !cacheControlNoTransformRegExp.test(cacheControl)
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
