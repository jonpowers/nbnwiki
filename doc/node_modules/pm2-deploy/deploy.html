<!DOCTYPE html>
<html>
<head>
  <title>deploy</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/pm2-deploy/deploy";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>deploy</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="sh"><span class="hljs-meta">#!/usr/bin/env bash

</span></pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>deploy(1) - Minimalistic shell script to deploy Git repositories.
Released under the MIT License.</p>
<p>https://github.com/visionmedia/deploy</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
VERSION=<span class="hljs-string">"0.6.0"</span>
CONFIG=./deploy.conf
LOG=/tmp/pm2-deploy.log
TEST=1
FORCE=0
REF=
ENV=

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Read PIPED JSON</p>

        </td>
        <td class="code highlight">
          <pre class="sh"><span class="hljs-built_in">read</span> conf

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<p>Output usage information.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">usage</span></span>() {
  cat &lt;&lt;-EOF

  Usage: deploy [options] &lt;env&gt; [<span class="hljs-built_in">command</span>]

  Options:

    -C, --chdir &lt;path&gt;   change the working directory to &lt;path&gt;
    -c, --config &lt;path&gt;  <span class="hljs-built_in">set</span> config path. defaults to ./deploy.conf
    -T, --no-tests       ignore <span class="hljs-built_in">test</span> hook
    -V, --version        output program version
    -h, --help           output <span class="hljs-built_in">help</span> information
    <span class="hljs-_">-f</span>, --force          skip <span class="hljs-built_in">local</span> change checking

  Commands:

    setup                run remote setup commands
    revert [n]           revert to [n]th last deployment or 1
    config [key]         output config file or [key]
    curr[ent]            output current release commit
    prev[ious]           output previous release commit
    <span class="hljs-built_in">exec</span>|run &lt;cmd&gt;       execute the given &lt;cmd&gt;
    list                 list previous deploy commits
    ref [ref]            deploy [ref]

EOF
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>Abort with <msg></p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">abort</span></span>() {
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"  <span class="hljs-variable">$@</span>"</span> 1&gt;&amp;2
  <span class="hljs-built_in">echo</span>
  <span class="hljs-built_in">exit</span> 1
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<p>Log <msg>.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">log</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"  â—‹ <span class="hljs-variable">$@</span>"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<p>Get config value by <key>.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">config_get</span></span>() {
    <span class="hljs-built_in">local</span> key=<span class="hljs-variable">$1</span>
    <span class="hljs-built_in">echo</span> $(expr <span class="hljs-string">"<span class="hljs-variable">$conf</span>"</span> : <span class="hljs-string">'.*"'</span><span class="hljs-variable">$key</span><span class="hljs-string">'":"\([^"]*\)"'</span>)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<p>Output version.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">version</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$VERSION</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>Return the ssh command to run.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">ssh_command</span></span>() {
  <span class="hljs-built_in">local</span> url=<span class="hljs-string">"`config_get user`@`config_get host`"</span>
  <span class="hljs-built_in">local</span> unexpanded_key=<span class="hljs-string">"`config_get key`"</span>
  <span class="hljs-built_in">local</span> key=<span class="hljs-string">"<span class="hljs-variable">${unexpanded_key/#\~/$HOME}</span>"</span>
  <span class="hljs-built_in">local</span> forward_agent=<span class="hljs-string">"`config_get forward-agent`"</span>
  <span class="hljs-built_in">local</span> port=<span class="hljs-string">"`config_get port`"</span>
  <span class="hljs-built_in">local</span> needs_tty=<span class="hljs-string">"`config_get needs_tty`"</span>
  <span class="hljs-built_in">local</span> ssh_options=<span class="hljs-string">"`config_get ssh_options`"</span>

  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$forward_agent</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> agent=<span class="hljs-string">"-A"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$key</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> identity=<span class="hljs-string">"-i <span class="hljs-variable">$key</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$port</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> port=<span class="hljs-string">"-p <span class="hljs-variable">$port</span>"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$needs_tty</span>"</span> &amp;&amp; <span class="hljs-built_in">local</span> tty=<span class="hljs-string">"-t"</span>
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"ssh_options"</span> &amp;&amp; <span class="hljs-built_in">local</span> ssh_opts=<span class="hljs-string">"<span class="hljs-variable">$ssh_options</span>"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"ssh <span class="hljs-variable">$ssh_opts</span> <span class="hljs-variable">$tty</span> <span class="hljs-variable">$agent</span> <span class="hljs-variable">$port</span> <span class="hljs-variable">$identity</span> <span class="hljs-variable">$url</span>"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>Run the given remote <cmd>.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">runRemote</span></span>() {
  <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`ssh_command`"</span>
  <span class="hljs-built_in">echo</span> <span class="hljs-variable">$shell</span> <span class="hljs-string">"\"<span class="hljs-variable">$@</span>\""</span> &gt;&gt; <span class="hljs-variable">$LOG</span>
  <span class="hljs-variable">$shell</span> <span class="hljs-variable">$@</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11"></a>
</div>
<p>Run the given local <cmd>.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">runLocal</span></span>() {
  <span class="hljs-built_in">echo</span> <span class="hljs-string">"\"<span class="hljs-variable">$@</span>\""</span> &gt;&gt; <span class="hljs-variable">$LOG</span>
  /usr/bin/env bash -c <span class="hljs-string">"$*"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-12" id="section-12"></a>
</div>
<p>Run the given <cmd> either locally or remotely</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">run</span></span>() {
  <span class="hljs-built_in">local</span> host=<span class="hljs-string">"`config_get host`"</span>
  <span class="hljs-keyword">if</span> [[ <span class="hljs-variable">$host</span> == localhost ]]
  <span class="hljs-keyword">then</span>
    runLocal <span class="hljs-variable">$@</span>
  <span class="hljs-keyword">else</span>
    runRemote <span class="hljs-variable">$@</span>
  <span class="hljs-keyword">fi</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13"></a>
</div>
<p>Output config or [key].</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">config</span></span>() {
    <span class="hljs-built_in">echo</span> $(expr <span class="hljs-string">"<span class="hljs-variable">$conf</span>"</span> : <span class="hljs-string">'.*"$key":"\([^"]*\)"'</span>)
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14"></a>
</div>
<p>Execute hook <name> relative to the path configured.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">hook</span></span>() {
  <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$1</span>"</span> || abort hook name required
  <span class="hljs-built_in">local</span> hook=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> path=`config_get path`
  <span class="hljs-built_in">local</span> cmd=`config_get <span class="hljs-variable">$hook</span>`
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">log</span> <span class="hljs-string">"executing <span class="hljs-variable">$hook</span> \`<span class="hljs-variable">$cmd</span>\`"</span>
    run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/current; \
      SHARED=\"<span class="hljs-variable">$path</span>/shared\" \
      <span class="hljs-variable">$cmd</span> 2&gt;&amp;1 | tee -a <span class="hljs-variable">$LOG</span>; \
      exit \${PIPESTATUS[0]}"</span>
    <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">log</span> hook <span class="hljs-variable">$hook</span>
  <span class="hljs-keyword">fi</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15"></a>
</div>
<p>Pre Setup hook runs on the host before the actual setup runs
multiple commands or a script</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">hook_pre_setup</span></span>() {
  <span class="hljs-built_in">local</span> cmd=`config_get pre-setup`
  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -n <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">local</span> is_script=(<span class="hljs-variable">$cmd</span>)
    <span class="hljs-keyword">if</span> [ <span class="hljs-_">-f</span> <span class="hljs-string">"<span class="hljs-variable">${is_script[0]}</span>"</span> ]; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">log</span> <span class="hljs-string">"executing pre-setup script \`<span class="hljs-variable">$cmd</span>\`"</span>
      <span class="hljs-built_in">local</span> shell=<span class="hljs-string">"`ssh_command`"</span>
      runLocal <span class="hljs-string">"<span class="hljs-variable">$shell</span> 'bash -s' -- &lt; <span class="hljs-variable">$cmd</span>"</span>
    <span class="hljs-keyword">else</span>
      <span class="hljs-built_in">log</span> <span class="hljs-string">"executing pre-setup \`<span class="hljs-variable">$cmd</span>\`"</span>
      run <span class="hljs-string">"<span class="hljs-variable">$cmd</span>"</span>
    <span class="hljs-keyword">fi</span>
    <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">log</span> hook pre-setup
  <span class="hljs-keyword">fi</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16"></a>
</div>
<p>Run setup.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">setup</span></span>() {
  <span class="hljs-built_in">local</span> path=`config_get path`
  <span class="hljs-built_in">local</span> repo=`config_get repo`
  <span class="hljs-built_in">local</span> ref=`config_get ref`
  <span class="hljs-built_in">local</span> branch=<span class="hljs-variable">${ref##*/}</span>
  hook_pre_setup || abort pre-setup hook failed
  run <span class="hljs-string">"mkdir -p <span class="hljs-variable">$path</span>/{shared/{logs,pids},source}"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort setup paths failed
  <span class="hljs-built_in">log</span> running setup
  <span class="hljs-built_in">log</span> cloning <span class="hljs-variable">$repo</span>
  run <span class="hljs-string">"git clone --depth=5 --branch <span class="hljs-variable">$branch</span> <span class="hljs-variable">$repo</span> <span class="hljs-variable">$path</span>/source"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort failed to <span class="hljs-built_in">clone</span>
  run <span class="hljs-string">"ln -sfn <span class="hljs-variable">$path</span>/source <span class="hljs-variable">$path</span>/current"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort symlink failed
  hook post-setup || abort post-setup hook failed
  <span class="hljs-built_in">log</span> setup complete
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17"></a>
</div>
<p>Deploy [ref].</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">deploy</span></span>() {
  <span class="hljs-built_in">local</span> ref=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> path=`config_get path`

  <span class="hljs-built_in">log</span> <span class="hljs-string">"deploying <span class="hljs-variable">${ref}</span>"</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18"></a>
</div>
<p>PR #50</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  <span class="hljs-built_in">log</span> executing pre-deploy-local
  <span class="hljs-built_in">local</span> pdl=`config_get pre-deploy-local`
  runLocal <span class="hljs-variable">$pdl</span>

  hook pre-deploy || abort pre-deploy hook failed

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19"></a>
</div>
<p>fetch source</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  <span class="hljs-built_in">log</span> fetching updates
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/source &amp;&amp; git fetch --depth=5 --all --tags"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort fetch failed

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-20" id="section-20"></a>
</div>
<p>latest tag</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> -z <span class="hljs-string">"<span class="hljs-variable">$ref</span>"</span>; <span class="hljs-keyword">then</span>
    <span class="hljs-built_in">log</span> fetching latest tag
    ref=`run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/source &amp;&amp; git for-each-ref refs/tags \
      --sort=-*authordate \
      --format='%(refname)' \
      --count=1 | cut -d '/' -f 3"</span>`
    <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort failed to determine latest tag
  <span class="hljs-keyword">fi</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21"></a>
</div>
<p>reset HEAD</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  <span class="hljs-built_in">log</span> resetting HEAD to <span class="hljs-variable">$ref</span>
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/source &amp;&amp; git reset --hard <span class="hljs-variable">$ref</span>"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort git reset failed

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22"></a>
</div>
<p>link current</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  run <span class="hljs-string">"ln -sfn <span class="hljs-variable">$path</span>/source <span class="hljs-variable">$path</span>/current"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort symlink failed

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-23" id="section-23"></a>
</div>
<p>deploy log</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/source &amp;&amp; \
      echo \`git rev-parse --short HEAD\` \
      &gt;&gt; <span class="hljs-variable">$path</span>/.deploys"</span>
  <span class="hljs-built_in">test</span> $? <span class="hljs-_">-eq</span> 0 || abort deploy <span class="hljs-built_in">log</span> append failed

  hook post-deploy || abort post-deploy hook failed

  <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$TEST</span> <span class="hljs-_">-eq</span> 1; <span class="hljs-keyword">then</span>
    hook <span class="hljs-built_in">test</span>
    <span class="hljs-keyword">if</span> <span class="hljs-built_in">test</span> $? <span class="hljs-_">-ne</span> 0; <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">log</span> tests failed, reverting deploy
      quickly_revert_to 1 &amp;&amp; <span class="hljs-built_in">log</span> <span class="hljs-string">"revert complete"</span> &amp;&amp; <span class="hljs-built_in">exit</span>
    <span class="hljs-keyword">fi</span>
  <span class="hljs-keyword">else</span>
    <span class="hljs-built_in">log</span> ignoring tests
  <span class="hljs-keyword">fi</span>

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-24" id="section-24"></a>
</div>
<p>done</p>

        </td>
        <td class="code highlight">
          <pre class="sh">  <span class="hljs-built_in">log</span> successfully deployed <span class="hljs-variable">$ref</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-25" id="section-25"></a>
</div>
<p>Get current commit.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">current_commit</span></span>() {
  <span class="hljs-built_in">local</span> path=`config_get path`
  run <span class="hljs-string">"cd <span class="hljs-variable">$path</span>/source &amp;&amp; \
      git rev-parse --short HEAD"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26"></a>
</div>
<p>Get <n>th deploy commit.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">nth_deploy_commit</span></span>() {
  <span class="hljs-built_in">local</span> n=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">local</span> path=`config_get path`
  run <span class="hljs-string">"cat <span class="hljs-variable">$path</span>/.deploys | tail -n <span class="hljs-variable">$n</span> | head -n 1 | cut -d ' ' -f 1"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-27" id="section-27"></a>
</div>
<p>List deploys.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">list_deploys</span></span>() {
  <span class="hljs-built_in">local</span> path=`config_get path`
  run <span class="hljs-string">"tac <span class="hljs-variable">$path</span>/.deploys | awk '{printf \"%d\t%s\n\", NR-1, \$0}'"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-28" id="section-28"></a>
</div>
<p>Revert to the <n>th last deployment, ignoring tests.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">quickly_revert_to</span></span>() {
  <span class="hljs-built_in">local</span> n=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">log</span> <span class="hljs-string">"quickly reverting <span class="hljs-variable">$n</span> deploy(s)"</span>
  <span class="hljs-built_in">local</span> commit=`nth_deploy_commit $((n + 1))`
  TEST=0 deploy <span class="hljs-string">"<span class="hljs-variable">$commit</span>"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29"></a>
</div>
<p>Revert to the <n>th last deployment.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">revert_to</span></span>() {
  <span class="hljs-built_in">local</span> n=<span class="hljs-variable">$1</span>
  <span class="hljs-built_in">log</span> <span class="hljs-string">"reverting <span class="hljs-variable">$n</span> deploy(s)"</span>
  <span class="hljs-built_in">local</span> commit=`nth_deploy_commit $((n + 1))`
  deploy <span class="hljs-string">"<span class="hljs-variable">$commit</span>"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30"></a>
</div>
<p>Ensure all changes are committed and pushed before deploying.</p>

        </td>
        <td class="code highlight">
          <pre class="sh">
<span class="hljs-function"><span class="hljs-title">check_for_local_changes</span></span>() {
  <span class="hljs-built_in">local</span> path=`config_get path`

  <span class="hljs-keyword">if</span> [ <span class="hljs-variable">$FORCE</span> <span class="hljs-_">-eq</span> 1 ]
  <span class="hljs-keyword">then</span>
      <span class="hljs-built_in">return</span>
  <span class="hljs-keyword">fi</span>
  git --no-pager diff --exit-code --quiet          || abort <span class="hljs-string">"commit or stash your changes before deploying"</span>
  git --no-pager diff --exit-code --quiet --cached || abort <span class="hljs-string">"commit your staged changes before deploying"</span>
  [ -z <span class="hljs-string">"`git rev-list @{upstream}.. -n 1`"</span> ]       || abort <span class="hljs-string">"push your changes before deploying"</span>
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31"></a>
</div>
<p>parse argv</p>

        </td>
        <td class="code highlight">
          <pre class="sh"><span class="hljs-keyword">while</span> <span class="hljs-built_in">test</span> <span class="hljs-variable">$#</span> <span class="hljs-_">-ne</span> 0; <span class="hljs-keyword">do</span>
  arg=<span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span>
  <span class="hljs-keyword">case</span> <span class="hljs-variable">$arg</span> <span class="hljs-keyword">in</span>
    -h|--help) usage; <span class="hljs-built_in">exit</span> ;;
    -V|--version) version; <span class="hljs-built_in">exit</span> ;;
    -C|--chdir) <span class="hljs-built_in">log</span> <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">cd</span> <span class="hljs-variable">$1</span>; <span class="hljs-built_in">shift</span> ;;
    -T|--no-tests) TEST=0 ;;
    -F|--force) FORCE=1 ;;
    run|<span class="hljs-built_in">exec</span>)  run <span class="hljs-string">"cd `config_get path`/current &amp;&amp; <span class="hljs-variable">$@</span>"</span>; <span class="hljs-built_in">exit</span> ;;
    console)  console; <span class="hljs-built_in">exit</span> ;;
    curr|current)  current_commit; <span class="hljs-built_in">exit</span> ;;
    prev|previous)  nth_deploy_commit 2; <span class="hljs-built_in">exit</span> ;;
    revert)  revert_to <span class="hljs-variable">${1-1}</span>; <span class="hljs-built_in">exit</span> ;;
    setup)  setup <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    list)  list_deploys; <span class="hljs-built_in">exit</span> ;;
    config) config <span class="hljs-variable">$@</span>; <span class="hljs-built_in">exit</span> ;;
    ref) REF=<span class="hljs-variable">$1</span> ;;
  <span class="hljs-keyword">esac</span>
<span class="hljs-keyword">done</span>

check_for_local_changes

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-32" id="section-32"></a>
</div>
<p>deploy</p>

        </td>
        <td class="code highlight">
          <pre class="sh">deploy <span class="hljs-string">"<span class="hljs-variable">${REF:-`config_get ref`}</span>"</span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
