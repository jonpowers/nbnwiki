<!DOCTYPE html>
<html>
<head>
  <title>mustache</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/mustache";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>mustache</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>

<span class="hljs-keyword">var</span> fs = <span class="hljs-built_in">require</span>(<span class="hljs-string">'fs'</span>),
    path = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);

<span class="hljs-keyword">var</span> Mustache = <span class="hljs-built_in">require</span>(<span class="hljs-string">'..'</span>);
<span class="hljs-keyword">var</span> pkg = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package'</span>);
<span class="hljs-keyword">var</span> partials = {};

<span class="hljs-keyword">var</span> partialsPaths = [];
<span class="hljs-keyword">var</span> partialArgIndex = <span class="hljs-number">-1</span>;

<span class="hljs-keyword">while</span> ((partialArgIndex = process.argv.indexOf(<span class="hljs-string">'-p'</span>)) &gt; <span class="hljs-number">-1</span>) {
  partialsPaths.push(process.argv.splice(partialArgIndex, <span class="hljs-number">2</span>)[<span class="hljs-number">1</span>]);
}

<span class="hljs-keyword">var</span> viewArg = process.argv[<span class="hljs-number">2</span>];
<span class="hljs-keyword">var</span> templateArg = process.argv[<span class="hljs-number">3</span>];
<span class="hljs-keyword">var</span> outputArg = process.argv[<span class="hljs-number">4</span>];

<span class="hljs-keyword">if</span> (hasVersionArg()) {
  <span class="hljs-keyword">return</span> <span class="hljs-built_in">console</span>.log(pkg.version);
}

<span class="hljs-keyword">if</span> (!templateArg || !viewArg) {
  <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Syntax: mustache &lt;view&gt; &lt;template&gt; [output]'</span>);
  process.exit(<span class="hljs-number">1</span>);
}

run(readPartials, readView, readTemplate, render, toStdout);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<div class="dox">
<div class="summary">
<p>Runs a list of functions as a waterfall.
Functions are runned one after the other in order, providing each
function the returned values of all the previously invoked functions.
Each function is expected to exit the process if an error occurs.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span> (<span class="hljs-params"><span class="hljs-regexp">/*args*/</span></span>) </span>{
  <span class="hljs-keyword">var</span> values = [];
  <span class="hljs-keyword">var</span> fns = <span class="hljs-built_in">Array</span>.prototype.slice.call(<span class="hljs-built_in">arguments</span>);

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invokeNextFn</span> (<span class="hljs-params">val</span>) </span>{
    values.unshift(val);
    <span class="hljs-keyword">if</span> (fns.length === <span class="hljs-number">0</span>) <span class="hljs-keyword">return</span>;
    invoke(fns.shift());
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">invoke</span> (<span class="hljs-params">fn</span>) </span>{
    fn.apply(<span class="hljs-literal">null</span>, [invokeNextFn].concat(values));
  }

  invoke(fns.shift());
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readView</span> (<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">var</span> view = isStdin(viewArg) ? process.openStdin() : fs.createReadStream(viewArg);

  streamToStr(view, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onDone</span> (<span class="hljs-params">str</span>) </span>{
    cb(parseView(str));
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">parseView</span> (<span class="hljs-params">str</span>) </span>{
  <span class="hljs-keyword">try</span> {
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">JSON</span>.parse(str);
  } <span class="hljs-keyword">catch</span> (ex) {
    <span class="hljs-built_in">console</span>.error(
      <span class="hljs-string">'Shooot, could not parse view as JSON.\n'</span> +
      <span class="hljs-string">'Tips: functions are not valid JSON and keys / values must be surround with double quotes.\n\n'</span> +
      ex.stack);

    process.exit(<span class="hljs-number">1</span>);
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readPartials</span> (<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">if</span> (!partialsPaths.length) <span class="hljs-keyword">return</span> cb();
  <span class="hljs-keyword">var</span> partialPath = partialsPaths.pop();
  <span class="hljs-keyword">var</span> partial = fs.createReadStream(partialPath);
  streamToStr(partial, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onDone</span> (<span class="hljs-params">str</span>) </span>{
    partials[getPartialName(partialPath)] = str;
    readPartials(cb);
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">readTemplate</span> (<span class="hljs-params">cb</span>) </span>{
  <span class="hljs-keyword">var</span> template = fs.createReadStream(templateArg);
  streamToStr(template, cb);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">render</span> (<span class="hljs-params">cb, templateStr, jsonView</span>) </span>{
  cb(Mustache.render(templateStr, jsonView, partials));
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toStdout</span> (<span class="hljs-params">cb, str</span>) </span>{
  <span class="hljs-keyword">if</span> (outputArg) {
    cb(fs.writeFileSync(outputArg, str));
  } <span class="hljs-keyword">else</span> {
    cb(process.stdout.write(str));
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">streamToStr</span> (<span class="hljs-params">stream, cb</span>) </span>{
  <span class="hljs-keyword">var</span> data = <span class="hljs-string">''</span>;

  stream.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onData</span> (<span class="hljs-params">chunk</span>) </span>{
    data += chunk;
  }).once(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onEnd</span> (<span class="hljs-params"></span>) </span>{
    cb(data.toString());
  }).on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">onError</span> (<span class="hljs-params">err</span>) </span>{
    <span class="hljs-keyword">if</span> (wasNotFound(err)) {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Could not find file:'</span>, err.path);
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Error while reading file:'</span>, err.message);
    }
    process.exit(<span class="hljs-number">1</span>);
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">isStdin</span> (<span class="hljs-params">view</span>) </span>{
  <span class="hljs-keyword">return</span> view === <span class="hljs-string">'-'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wasNotFound</span> (<span class="hljs-params">err</span>) </span>{
  <span class="hljs-keyword">return</span> err.code &amp;&amp; err.code === <span class="hljs-string">'ENOENT'</span>;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">hasVersionArg</span> (<span class="hljs-params"></span>) </span>{
  <span class="hljs-keyword">return</span> [<span class="hljs-string">'--version'</span>, <span class="hljs-string">'-v'</span>].some(<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">matchInArgs</span> (<span class="hljs-params">opt</span>) </span>{
    <span class="hljs-keyword">return</span> process.argv.indexOf(opt) &gt; <span class="hljs-number">-1</span>;
  });
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getPartialName</span> (<span class="hljs-params">filename</span>) </span>{
  <span class="hljs-keyword">return</span> path.basename(filename, <span class="hljs-string">'.mustache'</span>);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
