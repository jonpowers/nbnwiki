<!DOCTYPE html>
<html>
<head>
  <title>pm2-docker</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/.bin/pm2-docker";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>pm2-docker</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">#!/usr/bin/env node</span>
<span class="hljs-meta">
'use strict'</span>;

<span class="hljs-keyword">var</span> commander = <span class="hljs-built_in">require</span>(<span class="hljs-string">'commander'</span>);

<span class="hljs-keyword">var</span> debug     = <span class="hljs-built_in">require</span>(<span class="hljs-string">'debug'</span>)(<span class="hljs-string">'pm2:cli'</span>);
<span class="hljs-keyword">var</span> PM2       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'..'</span>);
<span class="hljs-keyword">var</span> Log       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../lib/API/Log'</span>);
<span class="hljs-keyword">var</span> cst       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../constants.js'</span>);
<span class="hljs-keyword">var</span> pkg       = <span class="hljs-built_in">require</span>(<span class="hljs-string">'../package.json'</span>);
<span class="hljs-keyword">var</span> path      = <span class="hljs-built_in">require</span>(<span class="hljs-string">'path'</span>);
<span class="hljs-keyword">var</span> pm2;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>process.env.PM2_SILENT = 'true';</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">
commander.version(pkg.version)
  .option(<span class="hljs-string">'--raw'</span>, <span class="hljs-string">'raw log output'</span>)
  .option(<span class="hljs-string">'--json'</span>, <span class="hljs-string">'output logs in json format'</span>)
  .option(<span class="hljs-string">'--log-date-format &lt;momentjs format&gt;'</span>, <span class="hljs-string">'add custom prefix timestamp to logs'</span>)
  .option(<span class="hljs-string">'--delay &lt;seconds&gt;'</span>, <span class="hljs-string">'delay start of configuration file by &lt;seconds&gt;'</span>, <span class="hljs-number">0</span>)
  .option(<span class="hljs-string">'--web [port]'</span>, <span class="hljs-string">'launch process web api on [port] default to 9615'</span>)
  .option(<span class="hljs-string">'--format'</span>, <span class="hljs-string">'output logs formated like key=val'</span>)
  .option(<span class="hljs-string">'--only &lt;application-name&gt;'</span>, <span class="hljs-string">'only act on one application of configuration'</span>)
  .option(<span class="hljs-string">'--secret [key]'</span>, <span class="hljs-string">'keymetrics secret key'</span>)
  .option(<span class="hljs-string">'--secret [key]'</span>, <span class="hljs-string">'keymetrics secret key'</span>)
  .option(<span class="hljs-string">'--public [key]'</span>, <span class="hljs-string">'keymetrics public key'</span>)
  .option(<span class="hljs-string">'--machine-name [name]'</span>, <span class="hljs-string">'keymetrics machine name'</span>)
  .option(<span class="hljs-string">'--auto-exit'</span>, <span class="hljs-string">'exit if all processes are errored/stopped or 0 apps launched'</span>)
  .option(<span class="hljs-string">'--env [name]'</span>, <span class="hljs-string">'select env_[name] env variables in process config file'</span>)
  .option(<span class="hljs-string">'--watch'</span>, <span class="hljs-string">'Watch and Restart'</span>)
  .option(<span class="hljs-string">'-i --instances &lt;number&gt;'</span>, <span class="hljs-string">'launch [number] instances with load-balancer'</span>)
  .usage(<span class="hljs-string">'start &lt;app&gt;'</span>);

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">start</span>(<span class="hljs-params">cmd, opts</span>) </span>{
  pm2 = <span class="hljs-keyword">new</span> PM2.custom({
    <span class="hljs-attr">secret_key</span> : process.env.KEYMETRICS_SECRET || commander.secret,
    <span class="hljs-attr">public_key</span> : process.env.KEYMETRICS_PUBLIC || commander.public,
    <span class="hljs-attr">machine_name</span> : process.env.INSTANCE_NAME || commander.machineName,
    <span class="hljs-attr">daemon_mode</span> : <span class="hljs-literal">true</span>
  });

  <span class="hljs-keyword">if</span> (commander.autoExit)
    autoExit();

  pm2.connect(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{

    <span class="hljs-keyword">if</span> (opts.web) {
      <span class="hljs-keyword">var</span> port = opts.web === <span class="hljs-literal">true</span> ? cst.WEB_PORT : opts.web;
      pm2.web(port);
    }

    run(cmd, opts);
  });
}

commander.command(<span class="hljs-string">'*'</span>)
  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cmd</span>)</span>{
    start(cmd, commander);
  });

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>@todo need to allow passing same option than pm2 start</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">commander.command(<span class="hljs-string">'start &lt;file|json_file&gt;'</span>)
  .description(<span class="hljs-string">'start json_file or application'</span>)
  .action(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">cmd</span>) </span>{
    start(cmd, commander);
  });

<span class="hljs-keyword">if</span> (process.argv.length == <span class="hljs-number">2</span>) {
  commander.outputHelp();
  process.exit(<span class="hljs-number">1</span>);
}

commander.parse(process.argv);

process.on(<span class="hljs-string">'SIGINT'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  exitPM2();
});

process.on(<span class="hljs-string">'SIGTERM'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  exitPM2();
});

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">run</span>(<span class="hljs-params">cmd, opts</span>) </span>{
  <span class="hljs-keyword">var</span> needRaw = commander.raw;

  <span class="hljs-keyword">var</span> timestamp = commander.logDateFormat;
  <span class="hljs-keyword">if</span> (timestamp)
    timestamp = <span class="hljs-keyword">typeof</span> cmd.timestamp === <span class="hljs-string">'string'</span> ? cmd.timestamp : <span class="hljs-string">'YYYY-MM-DD-HH:mm:ss'</span>;

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exec</span>(<span class="hljs-params"></span>) </span>{
    pm2.start(cmd, opts, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, obj</span>) </span>{
      <span class="hljs-keyword">if</span> (err)
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(err.message);
      <span class="hljs-keyword">if</span> (commander.format)
        Log.formatStream(pm2.Client, <span class="hljs-string">'all'</span>, needRaw, timestamp, <span class="hljs-literal">false</span>);
      <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (commander.json)
        Log.jsonStream(pm2.Client);
      <span class="hljs-keyword">else</span>
        Log.stream(pm2.Client, <span class="hljs-string">'all'</span>, needRaw, timestamp, <span class="hljs-literal">false</span>);
    });
  }
  setTimeout(exec.bind(<span class="hljs-keyword">this</span>), opts.delay * <span class="hljs-number">1000</span>);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">exitPM2</span>(<span class="hljs-params"></span>) </span>{
  <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Exiting PM2'</span>);
  pm2.kill(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    process.exit(<span class="hljs-number">0</span>);
  });
}

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Exit current PM2 instance if 0 app is online
function activated via --auto-exit</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">autoExit</span>(<span class="hljs-params"></span>) </span>{
  setTimeout(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    pm2.list(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">err, apps</span>) </span>{
      <span class="hljs-keyword">if</span> (err) <span class="hljs-built_in">console</span>.error(err.stack || err);

      <span class="hljs-keyword">var</span> online_count = <span class="hljs-number">0</span>;

      apps.forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">app</span>) </span>{
        <span class="hljs-keyword">if</span> (app.pm2_env.status == cst.ONLINE_STATUS ||
            app.pm2_env.status == cst.LAUNCHING_STATUS)
          online_count++;
      });

      <span class="hljs-keyword">if</span> (online_count == <span class="hljs-number">0</span>) {
        <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'0 application online, exiting'</span>);
        exitPM2();
      }
      autoExit();
    });
  }, <span class="hljs-number">3000</span>);
}

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
