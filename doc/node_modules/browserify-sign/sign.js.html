<!DOCTYPE html>
<html>
<head>
  <title>sign.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/browserify-sign/sign.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>sign.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<p>much of this based on https://github.com/indutny/self-signed/blob/gh-pages/lib/rsa.js</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> createHmac = <span class="hljs-built_in">require</span>(<span class="hljs-string">'create-hmac'</span>)
<span class="hljs-keyword">var</span> crt = <span class="hljs-built_in">require</span>(<span class="hljs-string">'browserify-rsa'</span>)
<span class="hljs-keyword">var</span> curves = <span class="hljs-built_in">require</span>(<span class="hljs-string">'./curves'</span>)
<span class="hljs-keyword">var</span> elliptic = <span class="hljs-built_in">require</span>(<span class="hljs-string">'elliptic'</span>)
<span class="hljs-keyword">var</span> parseKeys = <span class="hljs-built_in">require</span>(<span class="hljs-string">'parse-asn1'</span>)

<span class="hljs-keyword">var</span> BN = <span class="hljs-built_in">require</span>(<span class="hljs-string">'bn.js'</span>)
<span class="hljs-keyword">var</span> EC = elliptic.ec

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">sign</span> (<span class="hljs-params">hash, key, hashType, signType</span>) </span>{
  <span class="hljs-keyword">var</span> priv = parseKeys(key)
  <span class="hljs-keyword">if</span> (priv.curve) {
    <span class="hljs-keyword">if</span> (signType !== <span class="hljs-string">'ecdsa'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'wrong private key type'</span>)

    <span class="hljs-keyword">return</span> ecSign(hash, priv)
  } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (priv.type === <span class="hljs-string">'dsa'</span>) {
    <span class="hljs-keyword">if</span> (signType !== <span class="hljs-string">'dsa'</span>) {
      <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'wrong private key type'</span>)
    }
    <span class="hljs-keyword">return</span> dsaSign(hash, priv, hashType)
  } <span class="hljs-keyword">else</span> {
    <span class="hljs-keyword">if</span> (signType !== <span class="hljs-string">'rsa'</span>) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'wrong private key type'</span>)
  }

  <span class="hljs-keyword">var</span> len = priv.modulus.byteLength()
  <span class="hljs-keyword">var</span> pad = [ <span class="hljs-number">0</span>, <span class="hljs-number">1</span> ]
  <span class="hljs-keyword">while</span> (hash.length + pad.length + <span class="hljs-number">1</span> &lt; len) {
    pad.push(<span class="hljs-number">0xff</span>)
  }
  pad.push(<span class="hljs-number">0x00</span>)
  <span class="hljs-keyword">var</span> i = <span class="hljs-number">-1</span>
  <span class="hljs-keyword">while</span> (++i &lt; hash.length) {
    pad.push(hash[i])
  }

  <span class="hljs-keyword">var</span> out = crt(pad, priv)
  <span class="hljs-keyword">return</span> out
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">ecSign</span> (<span class="hljs-params">hash, priv</span>) </span>{
  <span class="hljs-keyword">var</span> curveId = curves[priv.curve.join(<span class="hljs-string">'.'</span>)]
  <span class="hljs-keyword">if</span> (!curveId) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'unknown curve '</span> + priv.curve.join(<span class="hljs-string">'.'</span>))

  <span class="hljs-keyword">var</span> curve = <span class="hljs-keyword">new</span> EC(curveId)
  <span class="hljs-keyword">var</span> key = curve.genKeyPair()

  key._importPrivate(priv.privateKey)
  <span class="hljs-keyword">var</span> out = key.sign(hash)

  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(out.toDER())
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">dsaSign</span> (<span class="hljs-params">hash, priv, algo</span>) </span>{
  <span class="hljs-keyword">var</span> x = priv.params.priv_key
  <span class="hljs-keyword">var</span> p = priv.params.p
  <span class="hljs-keyword">var</span> q = priv.params.q
  <span class="hljs-keyword">var</span> g = priv.params.g
  <span class="hljs-keyword">var</span> r = <span class="hljs-keyword">new</span> BN(<span class="hljs-number">0</span>)
  <span class="hljs-keyword">var</span> k
  <span class="hljs-keyword">var</span> H = bits2int(hash, q).mod(q)
  <span class="hljs-keyword">var</span> s = <span class="hljs-literal">false</span>
  <span class="hljs-keyword">var</span> kv = getKey(x, q, hash, algo)
  <span class="hljs-keyword">while</span> (s === <span class="hljs-literal">false</span>) {
    k = makeKey(q, kv, algo)
    r = makeR(g, k, p, q)
    s = k.invm(q).imul(H.add(x.mul(r))).mod(q)
    <span class="hljs-keyword">if</span> (!s.cmpn(<span class="hljs-number">0</span>)) {
      s = <span class="hljs-literal">false</span>
      r = <span class="hljs-keyword">new</span> BN(<span class="hljs-number">0</span>)
    }
  }
  <span class="hljs-keyword">return</span> toDER(r, s)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">toDER</span> (<span class="hljs-params">r, s</span>) </span>{
  r = r.toArray()
  s = s.toArray()

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Pad values</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (r[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x80</span>) {
    r = [ <span class="hljs-number">0</span> ].concat(r)
  }
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>Pad values</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (s[<span class="hljs-number">0</span>] &amp; <span class="hljs-number">0x80</span>) {
    s = [<span class="hljs-number">0</span>].concat(s)
  }

  <span class="hljs-keyword">var</span> total = r.length + s.length + <span class="hljs-number">4</span>
  <span class="hljs-keyword">var</span> res = [ <span class="hljs-number">0x30</span>, total, <span class="hljs-number">0x02</span>, r.length ]
  res = res.concat(r, [ <span class="hljs-number">0x02</span>, s.length ], s)
  <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> Buffer(res)
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">getKey</span> (<span class="hljs-params">x, q, hash, algo</span>) </span>{
  x = <span class="hljs-keyword">new</span> Buffer(x.toArray())
  <span class="hljs-keyword">if</span> (x.length &lt; q.byteLength()) {
    <span class="hljs-keyword">var</span> zeros = <span class="hljs-keyword">new</span> Buffer(q.byteLength() - x.length)
    zeros.fill(<span class="hljs-number">0</span>)
    x = Buffer.concat([zeros, x])
  }
  <span class="hljs-keyword">var</span> hlen = hash.length
  <span class="hljs-keyword">var</span> hbits = bits2octets(hash, q)
  <span class="hljs-keyword">var</span> v = <span class="hljs-keyword">new</span> Buffer(hlen)
  v.fill(<span class="hljs-number">1</span>)
  <span class="hljs-keyword">var</span> k = <span class="hljs-keyword">new</span> Buffer(hlen)
  k.fill(<span class="hljs-number">0</span>)
  k = createHmac(algo, k)
    .update(v)
    .update(<span class="hljs-keyword">new</span> Buffer([<span class="hljs-number">0</span>]))
    .update(x)
    .update(hbits)
    .digest()
  v = createHmac(algo, k)
    .update(v)
    .digest()
  k = createHmac(algo, k)
    .update(v)
    .update(<span class="hljs-keyword">new</span> Buffer([<span class="hljs-number">1</span>]))
    .update(x)
    .update(hbits)
    .digest()
  v = createHmac(algo, k)
    .update(v)
    .digest()
  <span class="hljs-keyword">return</span> {
    <span class="hljs-attr">k</span>: k,
    <span class="hljs-attr">v</span>: v
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bits2int</span> (<span class="hljs-params">obits, q</span>) </span>{
  <span class="hljs-keyword">var</span> bits = <span class="hljs-keyword">new</span> BN(obits)
  <span class="hljs-keyword">var</span> shift = (obits.length &lt;&lt; <span class="hljs-number">3</span>) - q.bitLength()
  <span class="hljs-keyword">if</span> (shift &gt; <span class="hljs-number">0</span>) {
    bits.ishrn(shift)
  }
  <span class="hljs-keyword">return</span> bits
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">bits2octets</span> (<span class="hljs-params">bits, q</span>) </span>{
  bits = bits2int(bits, q)
  bits = bits.mod(q)
  <span class="hljs-keyword">var</span> out = <span class="hljs-keyword">new</span> Buffer(bits.toArray())
  <span class="hljs-keyword">if</span> (out.length &lt; q.byteLength()) {
    <span class="hljs-keyword">var</span> zeros = <span class="hljs-keyword">new</span> Buffer(q.byteLength() - out.length)
    zeros.fill(<span class="hljs-number">0</span>)
    out = Buffer.concat([zeros, out])
  }
  <span class="hljs-keyword">return</span> out
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeKey</span> (<span class="hljs-params">q, kv, algo</span>) </span>{
  <span class="hljs-keyword">var</span> t, k

  <span class="hljs-keyword">do</span> {
    t = <span class="hljs-keyword">new</span> Buffer(<span class="hljs-string">''</span>)

    <span class="hljs-keyword">while</span> (t.length * <span class="hljs-number">8</span> &lt; q.bitLength()) {
      kv.v = createHmac(algo, kv.k)
        .update(kv.v)
        .digest()
      t = Buffer.concat([t, kv.v])
    }

    k = bits2int(t, q)
    kv.k = createHmac(algo, kv.k)
      .update(kv.v)
      .update(<span class="hljs-keyword">new</span> Buffer([<span class="hljs-number">0</span>]))
      .digest()
    kv.v = createHmac(algo, kv.k)
      .update(kv.v)
      .digest()
  } <span class="hljs-keyword">while</span> (k.cmp(q) !== <span class="hljs-number">-1</span>)

  <span class="hljs-keyword">return</span> k
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">makeR</span> (<span class="hljs-params">g, k, p, q</span>) </span>{
  <span class="hljs-keyword">return</span> g.toRed(BN.mont(p)).redPow(k).fromRed().mod(q)
}

<span class="hljs-built_in">module</span>.exports = sign
<span class="hljs-built_in">module</span>.exports.getKey = getKey
<span class="hljs-built_in">module</span>.exports.makeKey = makeKey

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
