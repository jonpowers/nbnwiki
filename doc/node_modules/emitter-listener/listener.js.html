<!DOCTYPE html>
<html>
<head>
  <title>listener.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/emitter-listener/listener.js";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>listener.js</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-meta">'use strict'</span>;

<span class="hljs-keyword">var</span> shimmer = <span class="hljs-built_in">require</span>(<span class="hljs-string">'shimmer'</span>);
<span class="hljs-keyword">var</span> wrap    = shimmer.wrap;
<span class="hljs-keyword">var</span> unwrap  = shimmer.unwrap;

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2"></a>
</div>
<p>Default to complaining loudly when things don't go according to plan.
dunderscores are boring</p>

        </td>
        <td class="code highlight">
          <pre class="javascript"><span class="hljs-keyword">var</span> SYMBOL = <span class="hljs-string">'wrap@before'</span>;

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_process</span>(<span class="hljs-params">self, listeners</span>) </span>{
  <span class="hljs-keyword">var</span> l = listeners.length;
  <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> p = <span class="hljs-number">0</span>; p &lt; l; p++) {
    <span class="hljs-keyword">var</span> listener = listeners[p];
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-3" id="section-3"></a>
</div>
<p>set up the listener so that onEmit can do whatever it needs</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">    <span class="hljs-keyword">var</span> before = self[SYMBOL];
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> before === <span class="hljs-string">'function'</span>) {
      before(listener);
    }
    <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(before)) {
      <span class="hljs-keyword">var</span> length = before.length;
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; length; i++) before[i](listener);
    }
  }
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_listeners</span>(<span class="hljs-params">self, event</span>) </span>{
  <span class="hljs-keyword">var</span> listeners;
  listeners = self._events &amp;&amp; self._events[event];
  <span class="hljs-keyword">if</span> (!<span class="hljs-built_in">Array</span>.isArray(listeners)) {
    <span class="hljs-keyword">if</span> (listeners) {
      listeners = [listeners];
    }
    <span class="hljs-keyword">else</span> {
      listeners = [];
    }
  }

  <span class="hljs-keyword">return</span> listeners;
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_findAndProcess</span>(<span class="hljs-params">self, event, before</span>) </span>{
  <span class="hljs-keyword">var</span> after = _listeners(self, event);
  <span class="hljs-keyword">var</span> unprocessed = after.filter(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">fn</span>) </span>{ <span class="hljs-keyword">return</span> before.indexOf(fn) === <span class="hljs-number">-1</span>; });
  <span class="hljs-keyword">if</span> (unprocessed.length &gt; <span class="hljs-number">0</span>) _process(self, unprocessed);
}

<span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">_wrap</span>(<span class="hljs-params">unwrapped, visit</span>) </span>{
  <span class="hljs-keyword">if</span> (!unwrapped) <span class="hljs-keyword">return</span>;

  <span class="hljs-keyword">var</span> wrapped = unwrapped;
  <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> unwrapped === <span class="hljs-string">'function'</span>) {
    wrapped = visit(unwrapped);
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(unwrapped)) {
    wrapped = [];
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i = <span class="hljs-number">0</span>; i &lt; unwrapped.length; i++) {
      wrapped[i] = visit(unwrapped[i]);
    }
  }
  <span class="hljs-keyword">return</span> wrapped;
}

<span class="hljs-built_in">module</span>.exports = <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">wrapEmitter</span>(<span class="hljs-params">emitter, onAddListener, onEmit</span>) </span>{
  <span class="hljs-keyword">if</span> (!emitter || !emitter.on || !emitter.addListener ||
      !emitter.removeListener || !emitter.emit) {
    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"can only wrap real EEs"</span>);
  }

  <span class="hljs-keyword">if</span> (!onAddListener) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"must have function to run on listener addition"</span>);
  <span class="hljs-keyword">if</span> (!onEmit) <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">"must have function to wrap listeners when emitting"</span>);

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4"></a>
</div>
<div class="dox">
<div class="summary">
<p>Attach a context to a listener, and make sure that this hook stays
attached to the emitter forevermore.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">adding</span>(<span class="hljs-params">on</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">added</span>(<span class="hljs-params">event, listener</span>) </span>{
      <span class="hljs-keyword">var</span> existing = _listeners(<span class="hljs-keyword">this</span>, event);

      <span class="hljs-keyword">try</span> {
        <span class="hljs-keyword">var</span> returned = on.call(<span class="hljs-keyword">this</span>, event, listener);
        _findAndProcess(<span class="hljs-keyword">this</span>, event, existing);
        <span class="hljs-keyword">return</span> returned;
      }
      <span class="hljs-keyword">finally</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5"></a>
</div>
<p>old-style streaming overwrites .on and .addListener, so rewrap</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.on.__wrapped) wrap(<span class="hljs-keyword">this</span>, <span class="hljs-string">'on'</span>, adding);
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.addListener.__wrapped) wrap(<span class="hljs-keyword">this</span>, <span class="hljs-string">'addListener'</span>, adding);
      }
    };
  }

  <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitting</span>(<span class="hljs-params">emit</span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">emitted</span>(<span class="hljs-params">event</span>) </span>{
      <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>._events || !<span class="hljs-keyword">this</span>._events[event]) <span class="hljs-keyword">return</span> emit.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);

      <span class="hljs-keyword">var</span> unwrapped = <span class="hljs-keyword">this</span>._events[event];

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-6" id="section-6"></a>
</div>
<div class="dox">
<div class="summary">
<p>Ensure that if removeListener gets called, it's working with the
unwrapped listeners.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">      <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">remover</span>(<span class="hljs-params">removeListener</span>) </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">removed</span>(<span class="hljs-params"></span>) </span>{
          <span class="hljs-keyword">this</span>._events[event] = unwrapped;
          <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> removeListener.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
          }
          <span class="hljs-keyword">finally</span> {
            unwrapped = <span class="hljs-keyword">this</span>._events[event];
            <span class="hljs-keyword">this</span>._events[event] = _wrap(unwrapped, onEmit);
          }
        };
      }
      wrap(<span class="hljs-keyword">this</span>, <span class="hljs-string">'removeListener'</span>, remover);

      <span class="hljs-keyword">try</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7"></a>
</div>
<div class="dox">
<div class="summary">
<p>At emit time, ensure that whatever else is going on, removeListener will
still work while at the same time running whatever hooks are necessary to
make sure the listener is run in the correct context.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        <span class="hljs-keyword">this</span>._events[event] = _wrap(unwrapped, onEmit);
        <span class="hljs-keyword">return</span> emit.apply(<span class="hljs-keyword">this</span>, <span class="hljs-built_in">arguments</span>);
      }
      <span class="hljs-keyword">finally</span> {
</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8"></a>
</div>
<div class="dox">
<div class="summary">
<p>Ensure that regardless of what happens when preparing and running the
listeners, the status quo ante is restored before continuing.</p>
</div>
<div class="body">
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="javascript">        unwrap(<span class="hljs-keyword">this</span>, <span class="hljs-string">'removeListener'</span>);
        <span class="hljs-keyword">this</span>._events[event] = unwrapped;
      }
    };
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9"></a>
</div>
<p>support multiple onAddListeners</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!emitter[SYMBOL]) {
    emitter[SYMBOL] = onAddListener;
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> emitter[SYMBOL] === <span class="hljs-string">'function'</span>) {
    emitter[SYMBOL] = [emitter[SYMBOL], onAddListener];
  }
  <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (<span class="hljs-built_in">Array</span>.isArray(emitter[SYMBOL])) {
    emitter[SYMBOL].push(onAddListener);
  }

</pre>
        </td>
      </tr>
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-10" id="section-10"></a>
</div>
<p>only wrap the core functions once</p>

        </td>
        <td class="code highlight">
          <pre class="javascript">  <span class="hljs-keyword">if</span> (!emitter.__wrapped) {
    wrap(emitter, <span class="hljs-string">'addListener'</span>, adding);
    wrap(emitter, <span class="hljs-string">'on'</span>,          adding);
    wrap(emitter, <span class="hljs-string">'emit'</span>,        emitting);

    emitter.__unwrap = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
      unwrap(emitter, <span class="hljs-string">'addListener'</span>);
      unwrap(emitter, <span class="hljs-string">'on'</span>);
      unwrap(emitter, <span class="hljs-string">'emit'</span>);
      <span class="hljs-keyword">delete</span> emitter[SYMBOL];
      <span class="hljs-keyword">delete</span> emitter.__wrapped;
    };
    emitter.__wrapped = <span class="hljs-literal">true</span>;
  }
};

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
