<!DOCTYPE html>
<html>
<head>
  <title>nan_weak.h</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/nan/nan_weak.h";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
    
      <tr>
        <td class="docs">
          <h1>nan_weak.h</h1>
        </td>
        <td class="code highlight"></td>
      </tr>
    
    
      <tr>
        <td class="docs">
          <div class="pilwrap">
  <a class="pilcrow" href="#section-1" id="section-1"></a>
</div>
<div class="dox">
<div class="summary">
<hr>
<p>NAN - Native Abstractions for Node.js</p>
</div>
<div class="body">
<p>Copyright (c) 2016 NAN contributors</p>
<p>MIT License <a href="https://github.com/nodejs/nan/blob/master/LICENSE.md">https://github.com/nodejs/nan/blob/master/LICENSE.md</a></p>
<hr>
</div>
</div>

        </td>
        <td class="code highlight">
          <pre class="c">
<span class="hljs-meta">#<span class="hljs-meta-keyword">ifndef</span> NAN_WEAK_H_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">define</span> NAN_WEAK_H_</span>

<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> kInternalFieldsInWeakCallback = <span class="hljs-number">2</span>;
<span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> kNoInternalFieldIndex = <span class="hljs-number">-1</span>;

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                      \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ \
    v8::WeakCallbackInfo<span class="hljs-meta-string">&lt;WeakCallbackInfo&lt;T&gt; &gt; const&amp;</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ \
    NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_SIG_ NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_SIG_ NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; IOJS_1_1_MODULE_VERSION</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ \
    v8::PhantomCallbackData<span class="hljs-meta-string">&lt;WeakCallbackInfo&lt;T&gt; &gt; const&amp;</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ \
    NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_SIG_ NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_SIG_ NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_12_MODULE_VERSION</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ \
    v8::PhantomCallbackData<span class="hljs-meta-string">&lt;WeakCallbackInfo&lt;T&gt; &gt; const&amp;</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ \
    v8::InternalFieldsCallbackData<span class="hljs-meta-string">&lt;WeakCallbackInfo&lt;T&gt;, void&gt; const&amp;</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_PARAMETER_CALLBACK_SIG_ NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_TWOFIELD_CALLBACK_SIG_ NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_CALLBACK_DATA_TYPE_ \
    v8::WeakCallbackData<span class="hljs-meta-string">&lt;S, WeakCallbackInfo&lt;T&gt; &gt; const&amp;</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_CALLBACK_SIG_ NAN_WEAK_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_CALLBACK_DATA_TYPE_ void *</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">define</span> NAN_WEAK_CALLBACK_SIG_ \
    v8::Persistent<span class="hljs-meta-string">&lt;v8::Value&gt;, NAN_WEAK_CALLBACK_DATA_TYPE_</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">class</span> WeakCallbackInfo {
 <span class="hljs-keyword">public</span>:
  <span class="hljs-function"><span class="hljs-keyword">typedef</span> <span class="hljs-title">void</span> <span class="hljs-params">(*Callback)</span><span class="hljs-params">(<span class="hljs-keyword">const</span> WeakCallbackInfo&lt;T&gt;&amp; data)</span></span>;
  WeakCallbackInfo(
      Persistent&lt;v8::Value&gt; *persistent
    , Callback callback
    , <span class="hljs-keyword">void</span> *parameter
    , <span class="hljs-keyword">void</span> *field1 = <span class="hljs-number">0</span>
    , <span class="hljs-keyword">void</span> *field2 = <span class="hljs-number">0</span>) :
        callback_(callback), isolate_(<span class="hljs-number">0</span>), parameter_(parameter) {
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">memcpy</span>(&amp;persistent_, persistent, <span class="hljs-keyword">sizeof</span> (v8::Persistent&lt;v8::Value&gt;));
    internal_fields_[<span class="hljs-number">0</span>] = field1;
    internal_fields_[<span class="hljs-number">1</span>] = field2;
  }
  <span class="hljs-keyword">inline</span> v8::<span class="hljs-function">Isolate *<span class="hljs-title">GetIsolate</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> isolate_; }
  <span class="hljs-function"><span class="hljs-keyword">inline</span> T *<span class="hljs-title">GetParameter</span><span class="hljs-params">()</span> <span class="hljs-keyword">const</span> </span>{ <span class="hljs-keyword">return</span> <span class="hljs-keyword">static_cast</span>&lt;T*&gt;(parameter_); }
  <span class="hljs-function"><span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> *<span class="hljs-title">GetInternalField</span><span class="hljs-params">(<span class="hljs-keyword">int</span> index)</span> <span class="hljs-keyword">const</span> </span>{
    assert((index == <span class="hljs-number">0</span> || index == <span class="hljs-number">1</span>) &amp;&amp; <span class="hljs-string">"internal field index out of bounds"</span>);
    <span class="hljs-keyword">if</span> (index == <span class="hljs-number">0</span>) {
      <span class="hljs-keyword">return</span> internal_fields_[<span class="hljs-number">0</span>];
    } <span class="hljs-keyword">else</span> {
      <span class="hljs-keyword">return</span> internal_fields_[<span class="hljs-number">1</span>];
    }
  }

 <span class="hljs-keyword">private</span>:
  NAN_DISALLOW_ASSIGN_COPY_MOVE(WeakCallbackInfo)
  Callback callback_;
  v8::Isolate *isolate_;
  <span class="hljs-keyword">void</span> *parameter_;
  <span class="hljs-keyword">void</span> *internal_fields_[kInternalFieldsInWeakCallback];
  v8::Persistent&lt;v8::Value&gt; persistent_;
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S, <span class="hljs-keyword">typename</span> M&gt; <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> Persistent;
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S&gt; <span class="hljs-keyword">friend</span> <span class="hljs-keyword">class</span> PersistentBase;
<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> NODE_MODULE_VERSION &lt;= NODE_0_12_MODULE_VERSION</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">if</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S&gt;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(NAN_WEAK_CALLBACK_SIG_ data)</span></span>;
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S&gt;
  <span class="hljs-function"><span class="hljs-keyword">static</span> WeakCallbackInfo *<span class="hljs-title">unwrap</span><span class="hljs-params">(NAN_WEAK_CALLBACK_DATA_TYPE_ data)</span></span>;
<span class="hljs-meta"># <span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoke</span><span class="hljs-params">(NAN_WEAK_CALLBACK_SIG_ data)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">static</span> WeakCallbackInfo *<span class="hljs-title">unwrap</span><span class="hljs-params">(NAN_WEAK_CALLBACK_DATA_TYPE_ data)</span></span>;
<span class="hljs-meta"># <span class="hljs-meta-keyword">endif</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                     \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">bool</span> isFirstPass&gt;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeparameter</span><span class="hljs-params">(NAN_WEAK_PARAMETER_CALLBACK_SIG_ data)</span></span>;
  <span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">bool</span> isFirstPass&gt;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoketwofield</span><span class="hljs-params">(NAN_WEAK_TWOFIELD_CALLBACK_SIG_ data)</span></span>;
<span class="hljs-meta"># <span class="hljs-meta-keyword">else</span></span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeparameter</span><span class="hljs-params">(NAN_WEAK_PARAMETER_CALLBACK_SIG_ data)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invoketwofield</span><span class="hljs-params">(NAN_WEAK_TWOFIELD_CALLBACK_SIG_ data)</span></span>;
<span class="hljs-meta"># <span class="hljs-meta-keyword">endif</span></span>
  <span class="hljs-function"><span class="hljs-keyword">static</span> WeakCallbackInfo *<span class="hljs-title">unwrapparameter</span><span class="hljs-params">(
      NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ data)</span></span>;
  <span class="hljs-function"><span class="hljs-keyword">static</span> WeakCallbackInfo *<span class="hljs-title">unwraptwofield</span><span class="hljs-params">(
      NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ data)</span></span>;
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>
};


<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                      \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">bool</span> isFirstPass&gt;
<span class="hljs-keyword">void</span>
WeakCallbackInfo&lt;T&gt;::invokeparameter(NAN_WEAK_PARAMETER_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwrapparameter(data);
  <span class="hljs-keyword">if</span> (isFirstPass) {
    cbinfo-&gt;persistent_.Reset();
    data.SetSecondPassCallback(invokeparameter&lt;<span class="hljs-literal">false</span>&gt;);
  } <span class="hljs-keyword">else</span> {
    cbinfo-&gt;callback_(*cbinfo);
    <span class="hljs-keyword">delete</span> cbinfo;
  }
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">bool</span> isFirstPass&gt;
<span class="hljs-keyword">void</span>
WeakCallbackInfo&lt;T&gt;::invoketwofield(NAN_WEAK_TWOFIELD_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwraptwofield(data);
  <span class="hljs-keyword">if</span> (isFirstPass) {
    cbinfo-&gt;persistent_.Reset();
    data.SetSecondPassCallback(invoketwofield&lt;<span class="hljs-literal">false</span>&gt;);
  } <span class="hljs-keyword">else</span> {
    cbinfo-&gt;callback_(*cbinfo);
    <span class="hljs-keyword">delete</span> cbinfo;
  }
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwrapparameter(
    NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo =
      <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(data.GetParameter());
  cbinfo-&gt;isolate_ = data.GetIsolate();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwraptwofield(
    NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo =
      <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(data.GetInternalField(<span class="hljs-number">0</span>));
  cbinfo-&gt;isolate_ = data.GetIsolate();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_PARAMETER_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_TWOFIELD_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta"># <span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_12_MODULE_VERSION</span>

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">void</span>
WeakCallbackInfo&lt;T&gt;::invokeparameter(NAN_WEAK_PARAMETER_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwrapparameter(data);
  cbinfo-&gt;persistent_.Reset();
  cbinfo-&gt;callback_(*cbinfo);
  <span class="hljs-keyword">delete</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">void</span>
WeakCallbackInfo&lt;T&gt;::invoketwofield(NAN_WEAK_TWOFIELD_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwraptwofield(data);
  cbinfo-&gt;persistent_.Reset();
  cbinfo-&gt;callback_(*cbinfo);
  <span class="hljs-keyword">delete</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwrapparameter(
    NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo =
       <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(data.GetParameter());
  cbinfo-&gt;isolate_ = data.GetIsolate();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwraptwofield(
    NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo =
       <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(data.GetInternalField1());
  cbinfo-&gt;isolate_ = data.GetIsolate();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_PARAMETER_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_TWOFIELD_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_PARAMETER_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_TWOFIELD_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S&gt;
<span class="hljs-keyword">void</span> WeakCallbackInfo&lt;T&gt;::invoke(NAN_WEAK_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwrap(data);
  cbinfo-&gt;persistent_.Reset();
  cbinfo-&gt;callback_(*cbinfo);
  <span class="hljs-keyword">delete</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> S&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwrap(
    NAN_WEAK_CALLBACK_DATA_TYPE_ data) {
  <span class="hljs-keyword">void</span> *parameter = data.GetParameter();
  WeakCallbackInfo&lt;T&gt; *cbinfo =
      <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(parameter);
  cbinfo-&gt;isolate_ = data.GetIsolate();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">void</span> WeakCallbackInfo&lt;T&gt;::invoke(NAN_WEAK_CALLBACK_SIG_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo = unwrap(data);
  cbinfo-&gt;persistent_.Dispose();
  cbinfo-&gt;persistent_.Clear();
  cbinfo-&gt;callback_(*cbinfo);
  <span class="hljs-keyword">delete</span> cbinfo;
}

<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
WeakCallbackInfo&lt;T&gt; *WeakCallbackInfo&lt;T&gt;::unwrap(
    NAN_WEAK_CALLBACK_DATA_TYPE_ data) {
  WeakCallbackInfo&lt;T&gt; *cbinfo =
      <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;T&gt;*&gt;(data);
  cbinfo-&gt;isolate_ = v8::Isolate::GetCurrent();
  <span class="hljs-keyword">return</span> cbinfo;
}

<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_CALLBACK_SIG_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">undef</span> NAN_WEAK_CALLBACK_DATA_TYPE_</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> defined(V8_MAJOR_VERSION) &amp;&amp; (V8_MAJOR_VERSION &gt; 4 ||                      \
  (V8_MAJOR_VERSION == 4 &amp;&amp; defined(V8_MINOR_VERSION) &amp;&amp; V8_MINOR_VERSION &gt;= 3))</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> M&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> P&gt;
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> Persistent&lt;T, M&gt;::SetWeak(
    P *parameter
  , <span class="hljs-keyword">typename</span> WeakCallbackInfo&lt;P&gt;::Callback callback
  , WeakCallbackType type) {
  WeakCallbackInfo&lt;P&gt; *wcbd;
  <span class="hljs-keyword">if</span> (type == WeakCallbackType::kParameter) {
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , parameter);
    v8::PersistentBase&lt;T&gt;::SetWeak(
        wcbd
      , WeakCallbackInfo&lt;P&gt;::<span class="hljs-keyword">template</span> invokeparameter&lt;<span class="hljs-literal">true</span>&gt;
      , type);
  } <span class="hljs-keyword">else</span> {
    v8::Local&lt;T&gt;* self = <span class="hljs-keyword">reinterpret_cast</span>&lt;v8::Local&lt;T&gt;*&gt;(<span class="hljs-keyword">this</span>);
    assert((*self)-&gt;IsObject());
    <span class="hljs-keyword">int</span> count = (*self)-&gt;InternalFieldCount();
    <span class="hljs-keyword">void</span> *internal_fields[kInternalFieldsInWeakCallback] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; i &lt; kInternalFieldsInWeakCallback; i++) {
      internal_fields[i] = (*self)-&gt;GetAlignedPointerFromInternalField(i);
    }
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , <span class="hljs-number">0</span>
      , internal_fields[<span class="hljs-number">0</span>]
      , internal_fields[<span class="hljs-number">1</span>]);
    (*self)-&gt;SetAlignedPointerInInternalField(<span class="hljs-number">0</span>, wcbd);
    v8::PersistentBase&lt;T&gt;::SetWeak(
        <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;P&gt;*&gt;(<span class="hljs-number">0</span>)
      , WeakCallbackInfo&lt;P&gt;::<span class="hljs-keyword">template</span> invoketwofield&lt;<span class="hljs-literal">true</span>&gt;
      , type);
  }
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; IOJS_1_1_MODULE_VERSION</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> M&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> P&gt;
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> Persistent&lt;T, M&gt;::SetWeak(
    P *parameter
  , <span class="hljs-keyword">typename</span> WeakCallbackInfo&lt;P&gt;::Callback callback
  , WeakCallbackType type) {
  WeakCallbackInfo&lt;P&gt; *wcbd;
  <span class="hljs-keyword">if</span> (type == WeakCallbackType::kParameter) {
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , parameter);
    v8::PersistentBase&lt;T&gt;::SetPhantom(
        wcbd
      , WeakCallbackInfo&lt;P&gt;::invokeparameter);
  } <span class="hljs-keyword">else</span> {
    v8::Local&lt;T&gt;* self = <span class="hljs-keyword">reinterpret_cast</span>&lt;v8::Local&lt;T&gt;*&gt;(<span class="hljs-keyword">this</span>);
    assert((*self)-&gt;IsObject());
    <span class="hljs-keyword">int</span> count = (*self)-&gt;InternalFieldCount();
    <span class="hljs-keyword">void</span> *internal_fields[kInternalFieldsInWeakCallback] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; i &lt; kInternalFieldsInWeakCallback; i++) {
      internal_fields[i] = (*self)-&gt;GetAlignedPointerFromInternalField(i);
    }
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , <span class="hljs-number">0</span>
      , internal_fields[<span class="hljs-number">0</span>]
      , internal_fields[<span class="hljs-number">1</span>]);
    (*self)-&gt;SetAlignedPointerInInternalField(<span class="hljs-number">0</span>, wcbd);
    v8::PersistentBase&lt;T&gt;::SetPhantom(
        <span class="hljs-keyword">static_cast</span>&lt;WeakCallbackInfo&lt;P&gt;*&gt;(<span class="hljs-number">0</span>)
      , WeakCallbackInfo&lt;P&gt;::invoketwofield
      , <span class="hljs-number">0</span>
      , count &gt; <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : kNoInternalFieldIndex);
  }
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_12_MODULE_VERSION</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> M&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> P&gt;
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> Persistent&lt;T, M&gt;::SetWeak(
    P *parameter
  , <span class="hljs-keyword">typename</span> WeakCallbackInfo&lt;P&gt;::Callback callback
  , WeakCallbackType type) {
  WeakCallbackInfo&lt;P&gt; *wcbd;
  <span class="hljs-keyword">if</span> (type == WeakCallbackType::kParameter) {
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , parameter);
    v8::PersistentBase&lt;T&gt;::SetPhantom(
        wcbd
      , WeakCallbackInfo&lt;P&gt;::invokeparameter);
  } <span class="hljs-keyword">else</span> {
    v8::Local&lt;T&gt;* self = <span class="hljs-keyword">reinterpret_cast</span>&lt;v8::Local&lt;T&gt;*&gt;(<span class="hljs-keyword">this</span>);
    assert((*self)-&gt;IsObject());
    <span class="hljs-keyword">int</span> count = (*self)-&gt;InternalFieldCount();
    <span class="hljs-keyword">void</span> *internal_fields[kInternalFieldsInWeakCallback] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; i &lt; kInternalFieldsInWeakCallback; i++) {
      internal_fields[i] = (*self)-&gt;GetAlignedPointerFromInternalField(i);
    }
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , <span class="hljs-number">0</span>
      , internal_fields[<span class="hljs-number">0</span>]
      , internal_fields[<span class="hljs-number">1</span>]);
    (*self)-&gt;SetAlignedPointerInInternalField(<span class="hljs-number">0</span>, wcbd);
    v8::PersistentBase&lt;T&gt;::SetPhantom(
        WeakCallbackInfo&lt;P&gt;::invoketwofield
      , <span class="hljs-number">0</span>
      , count &gt; <span class="hljs-number">1</span> ? <span class="hljs-number">1</span> : kNoInternalFieldIndex);
  }
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">elif</span> NODE_MODULE_VERSION &gt; NODE_0_10_MODULE_VERSION</span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T, <span class="hljs-keyword">typename</span> M&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> P&gt;
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> Persistent&lt;T, M&gt;::SetWeak(
    P *parameter
  , <span class="hljs-keyword">typename</span> WeakCallbackInfo&lt;P&gt;::Callback callback
  , WeakCallbackType type) {
  WeakCallbackInfo&lt;P&gt; *wcbd;
  <span class="hljs-keyword">if</span> (type == WeakCallbackType::kParameter) {
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , parameter);
    v8::PersistentBase&lt;T&gt;::SetWeak(wcbd, WeakCallbackInfo&lt;P&gt;::invoke);
  } <span class="hljs-keyword">else</span> {
    v8::Local&lt;T&gt;* self = <span class="hljs-keyword">reinterpret_cast</span>&lt;v8::Local&lt;T&gt;*&gt;(<span class="hljs-keyword">this</span>);
    assert((*self)-&gt;IsObject());
    <span class="hljs-keyword">int</span> count = (*self)-&gt;InternalFieldCount();
    <span class="hljs-keyword">void</span> *internal_fields[kInternalFieldsInWeakCallback] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; i &lt; kInternalFieldsInWeakCallback; i++) {
      internal_fields[i] = (*self)-&gt;GetAlignedPointerFromInternalField(i);
    }
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , <span class="hljs-number">0</span>
      , internal_fields[<span class="hljs-number">0</span>]
      , internal_fields[<span class="hljs-number">1</span>]);
    v8::PersistentBase&lt;T&gt;::SetWeak(wcbd, WeakCallbackInfo&lt;P&gt;::invoke);
  }
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">else</span></span>
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> T&gt;
<span class="hljs-keyword">template</span>&lt;<span class="hljs-keyword">typename</span> P&gt;
<span class="hljs-keyword">inline</span> <span class="hljs-keyword">void</span> PersistentBase&lt;T&gt;::SetWeak(
    P *parameter
  , <span class="hljs-keyword">typename</span> WeakCallbackInfo&lt;P&gt;::Callback callback
  , WeakCallbackType type) {
  WeakCallbackInfo&lt;P&gt; *wcbd;
  <span class="hljs-keyword">if</span> (type == WeakCallbackType::kParameter) {
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , parameter);
    persistent.MakeWeak(wcbd, WeakCallbackInfo&lt;P&gt;::invoke);
  } <span class="hljs-keyword">else</span> {
    v8::Local&lt;T&gt;* self = <span class="hljs-keyword">reinterpret_cast</span>&lt;v8::Local&lt;T&gt;*&gt;(<span class="hljs-keyword">this</span>);
    assert((*self)-&gt;IsObject());
    <span class="hljs-keyword">int</span> count = (*self)-&gt;InternalFieldCount();
    <span class="hljs-keyword">void</span> *internal_fields[kInternalFieldsInWeakCallback] = {<span class="hljs-number">0</span>, <span class="hljs-number">0</span>};
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i = <span class="hljs-number">0</span>; i &lt; count &amp;&amp; i &lt; kInternalFieldsInWeakCallback; i++) {
      internal_fields[i] = (*self)-&gt;GetPointerFromInternalField(i);
    }
    wcbd = <span class="hljs-keyword">new</span> WeakCallbackInfo&lt;P&gt;(
        <span class="hljs-keyword">reinterpret_cast</span>&lt;Persistent&lt;v8::Value&gt;*&gt;(<span class="hljs-keyword">this</span>)
      , callback
      , <span class="hljs-number">0</span>
      , internal_fields[<span class="hljs-number">0</span>]
      , internal_fields[<span class="hljs-number">1</span>]);
    persistent.MakeWeak(wcbd, WeakCallbackInfo&lt;P&gt;::invoke);
  }
}
<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span>  <span class="hljs-comment">// NAN_WEAK_H_</span></span>

</pre>
        </td>
      </tr>
    
  </tbody>
</table>

  </div>
</body>
</html>
