<!DOCTYPE html>
<html>
<head>
  <title>README.md</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../../doc-style.css" />
  <script src="../../doc-filelist.js"></script>
  <script>
    var relativeDir = "../../";
    var thisFile = "node_modules/pmx/README.md";
    var defaultSidebar = true;
  </script>
  <script src="../../doc-script.js"></script>

</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">

      <div class="heading h1">
        <a href="#table-of-contents">Table of Contents</a>
      </div>

      <div class="heading h1">
        <a href="#installation">Installation</a>
      </div>

      <div class="heading h2">
        <a href="#expose-metrics-measure-anything">Expose Metrics: Measure anything</a>
      </div>

      <div class="heading h3">
        <a href="#metric-simple-value-reporting">Metric: Simple value reporting</a>
      </div>

      <div class="heading h4">
        <a href="#options">Options</a>
      </div>

      <div class="heading h3">
        <a href="#counter-sequential-value-change">Counter: Sequential value change</a>
      </div>

      <div class="heading h4">
        <a href="#options-1">Options</a>
      </div>

      <div class="heading h3">
        <a href="#meter-average-calculated-values">Meter: Average calculated values</a>
      </div>

      <div class="heading h4">
        <a href="#options-2">Options</a>
      </div>

      <div class="heading h3">
        <a href="#histogram">Histogram</a>
      </div>

      <div class="heading h4">
        <a href="#options-3">Options</a>
      </div>

      <div class="heading h2">
        <a href="#expose-functions-trigger-functions-remotely">Expose Functions: Trigger Functions remotely</a>
      </div>

      <div class="heading h3">
        <a href="#simple-actions">Simple actions</a>
      </div>

      <div class="heading h3">
        <a href="#scoped-actions-beta">Scoped actions (beta)</a>
      </div>

      <div class="heading h3">
        <a href="#alert-system-for-custom-metrics">Alert System for Custom Metrics</a>
      </div>

      <div class="heading h4">
        <a href="#options-4">Options</a>
      </div>

      <div class="heading h2">
        <a href="#report-alerts-errors-uncaught-exceptions">Report Alerts: Errors / Uncaught Exceptions</a>
      </div>

      <div class="heading h3">
        <a href="#custom-alert-notification">Custom alert notification</a>
      </div>

      <div class="heading h3">
        <a href="#add-verbosity-to-an-alert-express-error-handler">Add Verbosity to an Alert: Express Error handler</a>
      </div>

      <div class="heading h2">
        <a href="#emit-events">Emit Events</a>
      </div>

      <div class="heading h2">
        <a href="#application-level-network-traffic-monitoring-display-used-ports">Application level network traffic monitoring / Display used ports</a>
      </div>

      <div class="heading h2">
        <a href="#advanced-pmx-configuration">Advanced PMX configuration</a>
      </div>

      <div class="heading h2">
        <a href="#license">License</a>
      </div>

    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container">
    <div class="docs markdown"><div align="center">
  <a href="http://pm2.keymetrics.io">
    <img width=411px src="https://raw.githubusercontent.com/keymetrics/pmx/master/pres/logo.png">
  </a>
  <br/>
  <b><a href="https://github.com/Unitech/pm2">PM2</a> programmatic integration</b>
  <br/>
  <br/>
  <a href="https://www.bithound.io/github/keymetrics/pmx">
<img src="https://www.bithound.io/github/keymetrics/pmx/badges/score.svg"/>
  </a>
  <a href="https://travis-ci.org/keymetrics/pmx">
<img src="https://api.travis-ci.org/keymetrics/pmx.png?branch=master"/>
  </a>
  <a href="https://badge.fury.io/js/pmx">
<img src="https://www.bithound.io/github/keymetrics/pmx/badges/score.svg"/>
  </a>
<br/>
<br/>
</div>
<p>PMX allows you to create advanced interactions with <a href="https://github.com/Unitech/pm2">PM2</a> and <a href="https://app.keymetrics.io/">Keymetrics.io</a>.</p>
<div class="pilwrap" id="table-of-contents">
  <h1>
    <a href="#table-of-contents" name="table-of-contents" class="pilcrow"></a>
Table of Contents
  </h1>
</div>
<ul>
<li><a href="https://github.com/keymetrics/pmx/blob/master/README.md#installation"><strong>Installation</strong></a></li>
<li><a href="https://github.com/keymetrics/pmx#expose-metrics-measure-anything"><strong>Expose Custom Metrics</strong></a></li>
<li><a href="https://github.com/keymetrics/pmx#expose-functions-trigger-functions-remotely"><strong>Expose Triggerable Runtime Functions</strong></a></li>
<li><a href="https://github.com/keymetrics/pmx#alert-system-for-custom-metrics"><strong>Report Exceptions and Alerts</strong></a></li>
<li><a href="https://github.com/keymetrics/pmx#emit-events"><strong>Report Custom Events</strong></a></li>
<li><a href="https://github.com/keymetrics/pmx#application-level-network-traffic-monitoring--display-used-ports"><strong>Monitor network traffic</strong></a></li>
</ul>
<div class="pilwrap" id="installation">
  <h1>
    <a href="#installation" name="installation" class="pilcrow"></a>
Installation
  </h1>
</div>
<p>Install pmx with npm:</p>
<pre><code class="bash">$ npm install pmx --save
</code></pre>
<div class="pilwrap" id="expose-metrics-measure-anything">
  <h2>
    <a href="#expose-metrics-measure-anything" name="expose-metrics-measure-anything" class="pilcrow"></a>
Expose Metrics: Measure anything
  </h2>
</div>
<p>PMX allows you to expose code metrics from your code to the PM2 monit command or the Keymetrics Dashboard, in realtime and over time.</p>
<p>4 measurements are available:</p>
<ul>
<li><strong>Simple metrics</strong>: Values that can be read instantly
<ul>
<li>eg. Monitor variable value</li>
</ul>
</li>
<li><strong>Counter</strong>: Things that increment or decrement
<ul>
<li>eg. Downloads being processed, user connected</li>
</ul>
</li>
<li><strong>Meter</strong>: Things that are measured as events / interval
<ul>
<li>eg. Request per minute for a http server</li>
</ul>
</li>
<li><strong>Histogram</strong>: Keeps a reservoir of statistically relevant values biased towards the last 5 minutes to explore their distribution
<ul>
<li>eg. Monitor the mean of execution of a query into database</li>
</ul>
</li>
</ul>
<div class="pilwrap" id="metric-simple-value-reporting">
  <h3>
    <a href="#metric-simple-value-reporting" name="metric-simple-value-reporting" class="pilcrow"></a>
Metric: Simple value reporting
  </h3>
</div>
<p>This allow to expose values that can be read instantly.</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> probe = pmx.probe();

<span class="hljs-comment">// Here the value function will be called each second to get the value</span>
<span class="hljs-comment">// returned by Object.keys(users).length</span>
<span class="hljs-keyword">var</span> metric = probe.metric({
  <span class="hljs-attr">name</span>    : <span class="hljs-string">'Realtime user'</span>,
  <span class="hljs-attr">value</span>   : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-built_in">Object</span>.keys(users).length;
  }
});

<span class="hljs-comment">// Here we are going to call valvar.set() to set the new value</span>
<span class="hljs-keyword">var</span> metric_2 = probe.metric({
  <span class="hljs-attr">name</span>    : <span class="hljs-string">'Realtime Value'</span>
});

metric_2.set(<span class="hljs-number">23</span>);
</code></pre>
<div class="pilwrap" id="options">
  <h4>
    <a href="#options" name="options" class="pilcrow"></a>
Options
  </h4>
</div>
<ul>
<li><strong>name</strong>: Probe name</li>
<li><strong>value</strong>: (optional) function that allows to monitor a global variable</li>
</ul>
<div class="pilwrap" id="counter-sequential-value-change">
  <h3>
    <a href="#counter-sequential-value-change" name="counter-sequential-value-change" class="pilcrow"></a>
Counter: Sequential value change
  </h3>
</div>
<p>Things that increment or decrement.</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> probe = pmx.probe();

<span class="hljs-comment">// The counter will start at 0</span>
<span class="hljs-keyword">var</span> counter = probe.counter({
  <span class="hljs-attr">name</span> : <span class="hljs-string">'Current req processed'</span>
});

http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  <span class="hljs-comment">// Increment the counter, counter will eq 1</span>
  counter.inc();
  req.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">// Decrement the counter, counter will eq 0</span>
    counter.dec();
  });
});
</code></pre>
<div class="pilwrap" id="options-1">
  <h4>
    <a href="#options-1" name="options-1" class="pilcrow"></a>
Options
  </h4>
</div>
<ul>
<li><strong>name</strong>: Probe name</li>
</ul>
<div class="pilwrap" id="meter-average-calculated-values">
  <h3>
    <a href="#meter-average-calculated-values" name="meter-average-calculated-values" class="pilcrow"></a>
Meter: Average calculated values
  </h3>
</div>
<p>Things that are measured as events / interval.</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> probe = pmx.probe();

<span class="hljs-keyword">var</span> meter = probe.meter({
  <span class="hljs-attr">name</span>      : <span class="hljs-string">'req/sec'</span>,
  <span class="hljs-attr">samples</span>   : <span class="hljs-number">1</span>  <span class="hljs-comment">// This is per second. To get per min set this value to 60</span>
});

http.createServer(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">req, res</span>) </span>{
  meter.mark();
  res.end({<span class="hljs-attr">success</span>:<span class="hljs-literal">true</span>});
});
</code></pre>
<div class="pilwrap" id="options-2">
  <h4>
    <a href="#options-2" name="options-2" class="pilcrow"></a>
Options
  </h4>
</div>
<ul>
<li><strong>name</strong>: Probe name</li>
<li><strong>samples</strong>: (optional)(default: 1) Rate unit. Defaults to <strong>1</strong> sec.</li>
<li><strong>timeframe</strong>: (optional)(default: 60) timeframe over which events will be analyzed. Defaults to <strong>60</strong> sec.</li>
</ul>
<div class="pilwrap" id="histogram">
  <h3>
    <a href="#histogram" name="histogram" class="pilcrow"></a>
Histogram
  </h3>
</div>
<p>Keeps a resevoir of statistically relevant values biased towards the last 5 minutes to explore their distribution.</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> probe = pmx.probe();

<span class="hljs-keyword">var</span> histogram = probe.histogram({
  <span class="hljs-attr">name</span>        : <span class="hljs-string">'latency'</span>,
  <span class="hljs-attr">measurement</span> : <span class="hljs-string">'mean'</span>
});

<span class="hljs-keyword">var</span> latency = <span class="hljs-number">0</span>;

setInterval(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
  latency = <span class="hljs-built_in">Math</span>.round(<span class="hljs-built_in">Math</span>.random() * <span class="hljs-number">100</span>);
  histogram.update(latency);
}, <span class="hljs-number">100</span>);
</code></pre>
<div class="pilwrap" id="options-3">
  <h4>
    <a href="#options-3" name="options-3" class="pilcrow"></a>
Options
  </h4>
</div>
<ul>
<li><strong>name</strong>: Probe name</li>
<li><strong>agg_type</strong> : (optional)(default: none) Can be <code>sum</code>, <code>max</code>, <code>min</code>, <code>avg</code> (default) or <code>none</code>. It will impact the way the probe data are aggregated within the <strong>Keymetrics</strong> backend. Use <code>none</code> if this is irrelevant (eg: constant or string value).</li>
<li><strong>alert</strong> : (optional)(default: null) For <code>Meter</code> and <code>Counter</code> probes.  Creates an alert object (see below).</li>
</ul>
<div class="pilwrap" id="expose-functions-trigger-functions-remotely">
  <h2>
    <a href="#expose-functions-trigger-functions-remotely" name="expose-functions-trigger-functions-remotely" class="pilcrow"></a>
Expose Functions: Trigger Functions remotely
  </h2>
</div>
<p>Remotely trigger functions from Keymetrics. These metrics takes place in the main Keymetrics Dashboard page under the Custom Action section.</p>
<div class="pilwrap" id="simple-actions">
  <h3>
    <a href="#simple-actions" name="simple-actions" class="pilcrow"></a>
Simple actions
  </h3>
</div>
<p>Simple action allows to trigger a function from Keymetrics. The function takes a function as a parameter (reply here) and need to be called once the job is finished.</p>
<p>Example:</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>);

pmx.action(<span class="hljs-string">'db:clean'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">reply</span>) </span>{
  clean.db(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-comment">/**
     * reply() must be called at the end of the action
     */</span>
     reply({<span class="hljs-attr">success</span> : <span class="hljs-literal">true</span>});
  });
});
</code></pre>
<div class="pilwrap" id="scoped-actions-beta">
  <h3>
    <a href="#scoped-actions-beta" name="scoped-actions-beta" class="pilcrow"></a>
Scoped actions (beta)
  </h3>
</div>
<p>Scoped Actions are advanced remote actions that can be also triggered from Keymetrics.</p>
<p>Two arguments are passed to the function, data (optional data sent from Keymetrics) and res that allows to emit log data and to end the scoped action.</p>
<p>Example:</p>
<pre><code class="javascript">pmx.scopedAction(<span class="hljs-string">'long running lsof'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">data, res</span>) </span>{
  <span class="hljs-keyword">var</span> child = spawn(<span class="hljs-string">'lsof'</span>, []);

  child.stdout.on(<span class="hljs-string">'data'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>{
    chunk.toString().split(<span class="hljs-string">'\n'</span>).forEach(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">line</span>) </span>{
      res.send(line); <span class="hljs-comment">// This send log to Keymetrics to be saved (for tracking)</span>
    });
  });

  child.stdout.on(<span class="hljs-string">'end'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">chunk</span>) </span>{
    res.end(<span class="hljs-string">'end'</span>); <span class="hljs-comment">// This end the scoped action</span>
  });

  child.on(<span class="hljs-string">'error'</span>, <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">e</span>) </span>{
    res.error(e);  <span class="hljs-comment">// This report an error to Keymetrics</span>
  });

});
</code></pre>
<div class="pilwrap" id="alert-system-for-custom-metrics">
  <h3>
    <a href="#alert-system-for-custom-metrics" name="alert-system-for-custom-metrics" class="pilcrow"></a>
Alert System for Custom Metrics
  </h3>
</div>
<p><strong>(Specific to Keymetrics)</strong></p>
<p>This alert system can monitor a Probe value and launch an exception when hitting a particular value.</p>
<p>Example for a <code>cpu_usage</code> variable:</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> metric = probe.metric({
  <span class="hljs-attr">name</span>  : <span class="hljs-string">'CPU usage'</span>,
  <span class="hljs-attr">value</span> : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    <span class="hljs-keyword">return</span> cpu_usage;
  },
  <span class="hljs-attr">alert</span> : {
    <span class="hljs-attr">mode</span>  : <span class="hljs-string">'threshold'</span>,
    <span class="hljs-attr">value</span> : <span class="hljs-number">95</span>,
    <span class="hljs-attr">msg</span>   : <span class="hljs-string">'Detected over 95% CPU usage'</span>, <span class="hljs-comment">// optional</span>
    func  : <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ <span class="hljs-comment">//optional</span>
      <span class="hljs-built_in">console</span>.error(<span class="hljs-string">'Detected over 95% CPU usage'</span>);
    },
    <span class="hljs-attr">cmp</span>   : <span class="hljs-string">"&lt;"</span> <span class="hljs-comment">// optional</span>
  }
});
</code></pre>
<div class="pilwrap" id="options-4">
  <h4>
    <a href="#options-4" name="options-4" class="pilcrow"></a>
Options
  </h4>
</div>
<ul>
<li><strong>mode</strong> : <code>threshold</code>, <code>threshold-avg</code>.</li>
<li><strong>value</strong> : Value that will be used for the exception check.</li>
<li><strong>msg</strong> : String used for the exception.</li>
<li><strong>func</strong> :  <strong>optional</strong>. Function declenched when exception reached.</li>
<li><strong>cmp</strong> : <strong>optional</strong>. If current Probe value is not <code>&lt;</code>, <code>&gt;</code>, <code>=</code> to Threshold value the exception is launched. Can also be a function used for exception check taking 2 arguments and returning a bool.</li>
<li><strong>interval</strong> : <strong>optional</strong>, <code>threshold-avg</code> mode. Sample length for monitored value (180 seconds default).</li>
<li><strong>timeout</strong> : <strong>optional</strong>, <code>threshold-avg</code> mode. Time after which mean comparison starts (30 000 milliseconds default).</li>
</ul>
<div class="pilwrap" id="report-alerts-errors-uncaught-exceptions">
  <h2>
    <a href="#report-alerts-errors-uncaught-exceptions" name="report-alerts-errors-uncaught-exceptions" class="pilcrow"></a>
Report Alerts: Errors / Uncaught Exceptions
  </h2>
</div>
<p><strong>(Specific to Keymetrics)</strong></p>
<p>By default once PM2 is linked to Keymetrics, you will be alerted of any uncaught exception.
These errors are accessible in the <strong>Issue</strong> tab of Keymetrics.</p>
<div class="pilwrap" id="custom-alert-notification">
  <h3>
    <a href="#custom-alert-notification" name="custom-alert-notification" class="pilcrow"></a>
Custom alert notification
  </h3>
</div>
<p>If you need to alert about any critical errors you can do it programmatically:</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>);

pmx.notify({ <span class="hljs-attr">success</span> : <span class="hljs-literal">false</span> });

pmx.notify(<span class="hljs-string">'This is an error'</span>);

pmx.notify(<span class="hljs-keyword">new</span> <span class="hljs-built_in">Error</span>(<span class="hljs-string">'This is an error'</span>));
</code></pre>
<div class="pilwrap" id="add-verbosity-to-an-alert-express-error-handler">
  <h3>
    <a href="#add-verbosity-to-an-alert-express-error-handler" name="add-verbosity-to-an-alert-express-error-handler" class="pilcrow"></a>
Add Verbosity to an Alert: Express Error handler
  </h3>
</div>
<p>When an uncaught exception is happening you can track from which routes it has been thrown.
To do that you have to attach the middleware <code>pmx.expressErrorHandler</code> at then end of your routes mounting:</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>);

<span class="hljs-comment">// All my routes</span>
app.get(<span class="hljs-string">'/'</span> ...);
app.post(...);
<span class="hljs-comment">// All my routes</span>

<span class="hljs-comment">// Here I attach the middleware to get more verbosity on exception thrown</span>
app.use(pmx.expressErrorHandler());
</code></pre>
<div class="pilwrap" id="emit-events">
  <h2>
    <a href="#emit-events" name="emit-events" class="pilcrow"></a>
Emit Events
  </h2>
</div>
<p>Emit events and get historical and statistics.
This is available in the <strong>Events</strong> page of Keymetrics.</p>
<pre><code class="javascript"><span class="hljs-keyword">var</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>);

pmx.emit(<span class="hljs-string">'user:register'</span>, {
  <span class="hljs-attr">user</span> : <span class="hljs-string">'Alex registered'</span>,
  <span class="hljs-attr">email</span> : <span class="hljs-string">'thorustor@gmail.com'</span>
});
</code></pre>
<div class="pilwrap" id="application-level-network-traffic-monitoring-display-used-ports">
  <h2>
    <a href="#application-level-network-traffic-monitoring-display-used-ports" name="application-level-network-traffic-monitoring-display-used-ports" class="pilcrow"></a>
Application level network traffic monitoring / Display used ports
  </h2>
</div>
<p>You can monitor the network usage of a specific application by adding the option <code>network: true</code> when initializing PMX. If you enable the flag <code>ports: true</code> when you init pmx it will show which ports your app is listenting on.</p>
<p>These metrics will be shown in the Keymetrics Dashboard in the Custom Metrics section.</p>
<p>Example:</p>
<pre><code class="javascript">pmx.init({
  [...]
  network : <span class="hljs-literal">true</span>, <span class="hljs-comment">// Allow application level network monitoring</span>
  ports   : <span class="hljs-literal">true</span>  <span class="hljs-comment">// Display ports used by the application</span>
});
</code></pre>
<div class="pilwrap" id="advanced-pmx-configuration">
  <h2>
    <a href="#advanced-pmx-configuration" name="advanced-pmx-configuration" class="pilcrow"></a>
Advanced PMX configuration
  </h2>
</div>
<pre><code class="javascript"><span class="hljs-keyword">var</span> pmx = <span class="hljs-built_in">require</span>(<span class="hljs-string">'pmx'</span>).init({
  <span class="hljs-attr">http</span>          : <span class="hljs-literal">true</span>, <span class="hljs-comment">// (default: true) HTTP routes logging</span>
  custom_probes : <span class="hljs-literal">true</span>, <span class="hljs-comment">// (default: true) Auto expose JS Loop Latency and HTTP req/s as custom metrics</span>
  network       : <span class="hljs-literal">true</span>, <span class="hljs-comment">// (default: false) Network monitoring at the application level</span>
  ports         : <span class="hljs-literal">true</span>, <span class="hljs-comment">// (default: false) Shows which ports your app is listening on</span>

  <span class="hljs-comment">// Transaction Tracing system configuration</span>
  transactions  : <span class="hljs-literal">true</span>  <span class="hljs-comment">// (default: false) Enable transaction tracing</span>
  ignoreFilter: {
    <span class="hljs-string">'url'</span>: [],
    <span class="hljs-string">'method'</span>: [<span class="hljs-string">'OPTIONS'</span>]
  },
  <span class="hljs-comment">// can be 'express', 'hapi', 'http', 'restify'</span>
  excludedHooks: []
});
</code></pre>
<div class="pilwrap" id="license">
  <h2>
    <a href="#license" name="license" class="pilcrow"></a>
License
  </h2>
</div>
<p>MIT</p>
<p><a href="https://github.com/igrigorik/ga-beacon"><img src="https://ga-beacon.appspot.com/UA-51122580-2/pmx/readme?pixel&amp;useReferer" alt="GA"></a></p>
</div>
  </div>
</body>
</html>
